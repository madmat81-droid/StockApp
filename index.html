<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockApp (Static)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#0b0c10;color:#e6e6e6}
    .card{background:#15171e;border:1px solid #222}
    .navbar{background:#0f1116}
    .form-control, .form-select{background:#0d0f14;color:#e6e6e6;border-color:#262a33}
    .form-control:focus{box-shadow:none;border-color:#3b82f6}
    .btn-primary{background:#3b82f6;border-color:#3b82f6}
    a{color:#93c5fd}
    .badge-role{background:#374151}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#">StockApp</a>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light d-none">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-4">
  <!-- Auth Card -->
  <div id="cardAuth" class="card mb-4">
    <div class="card-body">
      <h3 class="h5 mb-3">Accesso</h3>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" autocomplete="username" placeholder="admin@example.com" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" autocomplete="current-password" placeholder="••••••" />
        </div>
        <div class="col-md-4">
          <button id="btnLogin" class="btn btn-primary w-100">Entra</button>
          <small class="text-secondary d-block mt-2">
            Modalità locale demo: <code>admin@example.com / admin</code>
          </small>
        </div>
      </div>
      <hr class="my-3">
      <details>
        <summary class="mb-2">Configurazione Firebase (opzionale)</summary>
        <p class="small text-secondary">
          Per usare Auth + Firestore senza server, incolla la tua config Firebase qui sotto e premi "Abilita Firebase".
        </p>
        <textarea id="firebaseConfig" class="form-control" rows="6"
          placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
        <div class="mt-2 d-flex gap-2">
          <button id="btnEnableFirebase" class="btn btn-outline-primary">Abilita Firebase</button>
          <button id="btnDisableFirebase" class="btn btn-outline-secondary">Disabilita</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="rowDash" class="row g-3 d-none">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h5 class="card-title">Articoli</h5>
        <p id="metricItems" class="display-6">0</p>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h5 class="card-title">Giacenza totale</h5>
        <p id="metricQty" class="display-6">0</p>
      </div></div>
    </div>
  </div>

  <!-- Stock Table -->
  <div id="cardStock" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Magazzino</h3>
        <input id="search" class="form-control" placeholder="Cerca codice o descrizione" style="max-width:320px" />
      </div>

      <div id="adminBar" class="mb-3 d-none">
        <div class="row g-2">
          <div class="col-md-3"><input id="newCode" class="form-control" placeholder="Codice" /></div>
          <div class="col-md-6"><input id="newDesc" class="form-control" placeholder="Descrizione" /></div>
          <div class="col-md-3"><button id="btnAdd" class="btn btn-success w-100">+ Aggiungi</button></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead><tr><th>Codice</th><th>Descrizione</th><th class="text-end">Q.tà</th><th class="text-end">Azioni</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-light">Esporta JSON</button>
        <label class="btn btn-outline-light mb-0">
          Importa JSON <input id="fileImport" type="file" accept="application/json" hidden>
        </label>
      </div>
    </div>
  </div>
</main>

<script type="module">
// =======================
// LOCAL STORAGE + STATE
// =======================
const LS_KEY = 'stockapp.items.v1';
let state = { user: null, items: [], firebase: null };
const uid = () => Math.random().toString(36).slice(2,10);
function loadLocal(){ try{ state.items = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.items=[]; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.items)); }

// =======================
// LOGIN / LOGOUT
// =======================
async function login(email, password){
  if(email==='admin@example.com' && password==='admin'){
    state.user = { email, role:'admin' };
    loadLocal(); render(); return;
  }
  alert('Credenziali non valide');
}
function logout(){ state.user=null; render(); }

// =======================
// RENDER UI
// =======================
function metrics(){ 
  const totalItems = state.items.length;
  const totalQty = state.items.reduce((a,b)=>a+parseInt(b.qty||0),0);
  return { totalItems, totalQty };
}
function render(){
  const auth = document.getElementById('cardAuth');
  const dash = document.getElementById('rowDash');
  const stock = document.getElementById('cardStock');
  const info = document.getElementById('userInfo');
  const out = document.getElementById('btnLogout');
  const admin = document.getElementById('adminBar');
  const tbody = document.getElementById('tbody');
  const { totalItems, totalQty } = metrics();

  if(!state.user){
    auth.classList.remove('d-none');
    dash.classList.add('d-none');
    stock.classList.add('d-none');
    info.classList.add('d-none');
    out.classList.add('d-none');
    return;
  }

  auth.classList.add('d-none');
  dash.classList.remove('d-none');
  stock.classList.remove('d-none');
  info.classList.remove('d-none');
  out.classList.remove('d-none');

  info.textContent = `${state.user.email} • ${state.user.role}`;
  document.getElementById('metricItems').textContent = totalItems;
  document.getElementById('metricQty').textContent = totalQty;

  const q = document.getElementById('search').value.toLowerCase();
  const items = state.items.filter(i => i.code.toLowerCase().includes(q) || i.description.toLowerCase().includes(q));
  tbody.innerHTML = '';
  for(const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.code}</td>
      <td>${it.description}</td>
      <td class="text-end">${it.qty}</td>
      <td class="text-end">
        <input type="number" value="1" style="width:80px" class="form-control form-control-sm d-inline me-1" id="qty_${it.id}">
        <button class="btn btn-sm btn-primary" onclick="move('${it.id}',1)">+ Carico</button>
        <button class="btn btn-sm btn-outline-light" onclick="move('${it.id}',-1)">- Scarico</button>
      </td>`;
    tbody.appendChild(tr);
  }
  admin.classList.toggle('d-none', state.user.role!=='admin');
}

// =======================
// STOCK ACTIONS
// =======================
function addItem(){
  const code = document.getElementById('newCode').value.trim();
  const desc = document.getElementById('newDesc').value.trim();
  if(!code) return alert('Codice obbligatorio');
  state.items.push({ id: uid(), code, description:desc, qty:0 });
  saveLocal(); render();
  document.getElementById('newCode').value=''; document.getElementById('newDesc').value='';
}
function move(id, sign){
  const input = document.getElementById('qty_'+id);
  const val = parseInt(input.value||1);
  const it = state.items.find(i=>i.id===id);
  if(!it) return;
  it.qty = (it.qty||0) + (val*sign);
  saveLocal(); render();
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(state.items,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'stockapp_export.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const arr = JSON.parse(e.target.result);
      if(!Array.isArray(arr)) throw new Error('Formato non valido');
      state.items = arr; saveLocal(); render();
    }catch{ alert('JSON non valido'); }
  };
  reader.readAsText(file);
}

// =======================
// EVENTS
// =======================
loadLocal(); render();
document.getElementById('btnLogin').onclick=()=>login(email.value,password.value);
document.getElementById('btnLogout').onclick=logout;
document.getElementById('btnAdd').onclick=addItem;
document.getElementById('btnExport').onclick=exportJSON;
document.getElementById('fileImport').onchange=(e)=>{ if(e.target.files[0]) importJSON(e.target.files[0]); };
document.getElementById('search').oninput=render;
</script>
</body>
</html>
