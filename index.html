<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0a0c10;--panel:#131622;--muted:#9aa3af;--border:#1f2330;--primary:#3b82f6;--accent:#10b981;--ford:#003DA5}
    body{background:var(--bg);color:#e8eaee;margin:0;padding:0;overflow-x:hidden}

    /* ===== AppBar ===== */
    header.appbar{background:var(--ford); color:#fff; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    header.appbar .bar-inner{display:flex;align-items:center;gap:16px;min-height:90px;padding:14px 18px}
    header.appbar .brand{display:flex;align-items:center;gap:14px;font-weight:900;font-size:clamp(24px,2.8vw,36px);letter-spacing:.4px}
    header.appbar .brand img{height:42px;width:auto;display:block}
    header.appbar .nav-actions{display:flex;gap:10px;margin-left:auto}
    .btn-header{--bs-btn-bg:#0a4fb8;--bs-btn-border-color:#0a4fb8;--bs-btn-hover-bg:#083f92;--bs-btn-hover-border-color:#083f92;--bs-btn-color:#fff}
    .btn-header-outline{--bs-btn-color:#fff;--bs-btn-border-color:#cfe3ff;--bs-btn-hover-bg:#0a4fb8;--bs-btn-hover-border-color:#cfe3ff}
    a.nav-link{color:#fff;text-decoration:none}
    a.nav-link.active{filter:brightness(1.1)}

    /* ===== Cards / Inputs ===== */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px}
    .form-control,.form-select{background:#0e1220;color:#e8eaee;border-color:#1e2432}
    .form-control:focus{box-shadow:none;border-color:var(--primary)}
    .btn-primary{background:var(--ford);border-color:var(--ford)}
    .btn-success{background:var(--accent);border-color:var(--accent)}
    .table-dark{--bs-table-bg:#111425;--bs-table-striped-bg:#0e1120}
    .badge-role{background:#1c2231}
    .muted{color:var(--muted)}

    /* ===== Login split full-viewport ===== */
    body.auth-mode{background:#000}
    body.auth-mode header.appbar{display:none!important}
    body.auth-mode main.container{padding:0!important;max-width:100%!important}
    #page-auth{padding:0;margin:0;min-height:100vh;width:100vw;margin-left:calc(50% - 50vw);margin-right:calc(50% - 50vw)}
    .login-split{width:100%;display:grid;grid-template-columns:1fr 1fr;min-height:100vh}
    .login-left{background:#ffffff;color:#0b1220;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;padding:48px}
    .login-header{margin-top:40px;text-align:center}
    .app-title{font-weight:900;color:var(--ford);font-size:clamp(40px,5vw,64px);line-height:1;margin-bottom:40px}
    .brand-logo{max-width:320px;height:auto;margin:0 auto 28px auto;display:block}
    .login-box{width:100%;max-width:480px;margin-top:24px}
    .login-left .card{background:#ffffff;color:#0b1220}
    .login-left .form-control{background:#ffffff;color:#0b1220;border-color:#d8dee9}
    .login-left .form-control:focus{border-color:var(--ford);box-shadow:0 0 0 .25rem rgba(0,61,165,.15)}
    .login-right{background:radial-gradient(ellipse at 20% 10%, rgba(0,0,0,.35), rgba(0,0,0,.65)), url('assets/bg.jpg') center/cover no-repeat}
    @media (max-width:992px){.login-split{grid-template-columns:1fr}.login-right{min-height:40vh}}

    /* ===== Background pagine (Stock, Stats, Users) ===== */
    body.page-bg:not(.auth-mode){
      min-height:100vh;
      background:
        radial-gradient(ellipse at 20% 10%, rgba(0,0,0,.35), rgba(0,0,0,.65)),
        url('assets/Sfondo FT.png') center center / cover no-repeat;
    }
    body.page-bg:not(.auth-mode) .card{ background:rgba(19,22,34,.92); }
  </style>
</head>
<body class="auth-mode">

  <!-- APP BAR (nascosta in login) -->
  <header class="appbar d-none">
    <div class="container bar-inner">
      <div class="brand">
        <img src="assets/logo.png" alt="logo"/>
        <span>StockApp</span>
      </div>
      <div class="nav-actions">
        <a class="btn btn-header nav-link" href="#/stock"><i class="bi bi-grid-3x3-gap me-1"></i>Stock</a>
        <a class="btn btn-header-outline nav-link" href="#/stats"><i class="bi bi-graph-up me-1"></i>Statistiche</a>
        <a id="navUsers" class="btn btn-header-outline nav-link d-none" href="#/users"><i class="bi bi-people me-1"></i>Utenti</a>
        <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
        <button id="btnLogout" class="btn btn-light d-none" type="button"><i class="bi bi-box-arrow-right me-1"></i>Logout</button>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <!-- LOGIN -->
    <section id="page-auth" class="bg-transparent">
      <div class="login-split">
        <div class="login-left">
          <div class="login-header">
            <div class="app-title">StockApp</div>
            <img src="assets/logo.png" alt="Logo aziendale" class="brand-logo"/>
          </div>
          <div class="login-box">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-4 p-md-5">
                <h1 class="h4 mb-3">Accedi</h1>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">Email</label>
                    <input id="email" class="form-control" autocomplete="username" placeholder="you@example.com" />
                  </div>
                  <div class="col-12">
                    <label class="form-label">Password</label>
                    <input id="password" type="password" class="form-control" autocomplete="current-password" placeholder="••••••" />
                  </div>
                  <div class="col-12 d-grid">
                    <button id="btnLogin" class="btn btn-primary btn-lg" type="button"><i class="bi bi-box-arrow-in-right me-1"></i>Entra</button>
                    <div id="authError" class="alert alert-danger mt-3 d-none" role="alert"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="login-right d-none d-lg-block"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dash" class="row g-3 d-none">
      <div class="col-md-6">
        <div class="card h-100"><div class="card-body d-flex align-items-center">
          <div class="me-auto"><h5 class="card-title mb-1">Articoli</h5><div class="muted small">Record visibili</div></div>
          <div id="metricItems" class="fs-1 fw-bold">0</div>
        </div></div>
      </div>
      <div class="col-md-6">
        <div class="card h-100"><div class="card-body d-flex align-items-center">
          <div class="me-auto"><h5 class="card-title mb-1">Giacenza totale</h5><div class="muted small">Somma Qty visibili</div></div>
          <div id="metricQty" class="fs-1 fw-bold">0</div>
        </div></div>
      </div>
    </section>

    <!-- STOCK -->
    <section id="page-stock" class="card mt-3 d-none">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3 gap-2">
          <h3 class="h5 me-auto mb-0">Magazzino</h3>
          <input id="search" class="form-control" placeholder="Cerca Finis/Complete/Descrizione/Note" style="max-width:380px" />
          <button id="btnExport" class="btn btn-outline-light" type="button"><i class="bi bi-download me-1"></i>Esporta</button>
          <select id="filterOwner" class="form-select d-none" style="max-width:220px"></select>
          <a id="quickUsers" href="#/users" class="btn btn-outline-light d-none"><i class="bi bi-people me-1"></i>Gestisci utenti</a>
        </div>

        <div class="mb-3">
          <div class="row g-2">
            <div class="col-lg-2"><input id="newFinis" class="form-control" placeholder="Finis Code" /></div>
            <div class="col-lg-2"><input id="newComplete" class="form-control" placeholder="Complete Code" /></div>
            <div class="col-lg-3"><input id="newDesc" class="form-control" placeholder="Descrizione" /></div>
            <div class="col-lg-3"><input id="newNote" class="form-control" placeholder="Note" /></div>
            <div class="col-lg-2 d-grid"><button id="btnAdd" class="btn btn-success" type="button"><i class="bi bi-plus-lg me-1"></i>Aggiungi</button></div>
          </div>
          <div class="muted small mt-1">I nuovi record saranno di: <span id="ownerHint">—</span></div>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead>
              <tr>
                <th>Finis</th>
                <th>Complete</th>
                <th>Descrizione</th>
                <th>Note</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Azioni</th>
                <th id="thOwner" class="d-none">Dealer</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- USERS (ADMIN) -->
    <section id="page-users" class="card mt-3 d-none">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3 gap-2">
          <h3 class="h5 me-auto mb-0">Gestione Utenti</h3>
          <input id="uSearch" class="form-control" placeholder="Cerca email" style="max-width:320px" />
        </div>

        <div class="row g-2 mb-3">
          <div class="col-lg-4"><input id="uNewEmail" class="form-control" placeholder="email@dominio.it" /></div>
          <div class="col-lg-3"><input id="uNewPassword" class="form-control" placeholder="password temporanea" /></div>
          <div class="col-lg-3"><input id="uNewDealer" class="form-control" placeholder="Dealer (facoltativo)" /></div>
          <div class="col-lg-2">
            <div class="input-group">
              <select id="uNewRole" class="form-select"><option value="user">User</option><option value="admin">Admin</option></select>
              <button id="btnCreateUser" class="btn btn-success" type="button" title="Crea utente"><i class="bi bi-person-plus"></i></button>
            </div>
          </div>
          <div id="uMsg" class="text-success small"></div>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead><tr><th>Email</th><th>Dealer</th><th>Ruolo</th><th>Stato</th><th class="text-end">Azioni</th></tr></thead>
            <tbody id="uBody"></tbody>
          </table>
        </div>
        <div class="muted small">Blocca/sblocca via Firestore; con Cloud Functions puoi anche cancellare da Authentication.</div>
      </div>
    </section>

    <!-- STATS -->
    <section id="page-stats" class="card mt-3 d-none">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3 gap-2">
          <h3 class="h5 me-auto mb-0">Statistiche</h3>
          <input id="sSearch" class="form-control" placeholder="Filtro testo" style="max-width:300px" />
          <select id="sOwner" class="form-select" style="max-width:200px"></select>
          <select id="sFinis" class="form-select" style="max-width:200px"><option value="__all__">Tutti i Finis</option></select>
          <button id="sApply" class="btn btn-primary" type="button"><i class="bi bi-funnel me-1"></i>Applica</button>
        </div>
        <div class="row g-4">
          <div class="col-12"><div class="card"><div class="card-body">
            <h6 class="mb-2">Andamento quantità nel tempo</h6>
            <canvas id="chartQtyTime" height="120"></canvas>
          </div></div></div>
          <div class="col-12"><div class="card"><div class="card-body">
            <h6 class="mb-2">Top codici per Qty</h6>
            <canvas id="chartTopCodes" height="120"></canvas>
          </div></div></div>
          <div class="col-12"><div class="card"><div class="card-body">
            <h6 class="mb-2">Distribuzione Qty per Owner</h6>
            <canvas id="chartByOwner" height="120"></canvas>
          </div></div></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== APP (Firebase) ===== -->
  <script type="module">
    import { initializeApp, getApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, runTransaction, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyABezXPgHhyvPknItXGyuvA-vKozNw6_qw",
      authDomain: "stockappdb-2420d.firebaseapp.com",
      projectId: "stockappdb-2420d",
      messagingSenderId: "856091877639",
      storageBucket: "stockappdb-2420d.appspot.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const fns  = getFunctions(app);
    await setPersistence(auth, browserLocalPersistence);

    let fnSetDisabled, fnDeleteUser;
    try { fnSetDisabled = httpsCallable(fns, 'adminSetDisabled'); } catch(_){}
    try { fnDeleteUser  = httpsCallable(fns, 'adminDeleteUser'); } catch(_){}

    /* Stato */
    let currentUser = null; // { uid, email, role, dealer, disabled }
    let itemsCache  = [];
    let chartTop=null, chartOwner=null, chartTime=null;
    let profilesMap = new Map(); // uid -> profile

    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const esc = s => (s ?? '').toString().replace(/[&<>"]|'/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const byEmail = e => (e||'').trim().toLowerCase();

    function showOnly(...ids){
      ['page-auth','page-dash','page-stock','page-users','page-stats'].forEach(id=>document.getElementById(id)?.classList.add('d-none'));
      ids.forEach(id=>document.getElementById(id)?.classList.remove('d-none'));
      if(ids.includes('page-auth')) document.body.classList.add('auth-mode'); else document.body.classList.remove('auth-mode');
    }
    function setActive(hash){ $$('.nav-link').forEach(a=>a.classList.remove('active')); const l=document.querySelector(`.nav-link[href="${hash}"]`); if(l) l.classList.add('active'); }
    function renderNav(){
      const info=document.getElementById('userInfo'), out=document.getElementById('btnLogout'), navUsers=document.getElementById('navUsers'), quick=document.getElementById('quickUsers');
      const appbar=document.querySelector('header.appbar');
      if(!currentUser){
        showOnly('page-auth'); setActive(''); document.body.classList.remove('page-bg');
        appbar?.classList.add('d-none');
        return;
      }
      appbar?.classList.remove('d-none');
      const dealerTxt = currentUser.dealer ? ` • ${currentUser.dealer}` : '';
      const badge = currentUser.disabled ? ' (bloccato)' : '';
      if(info){ info.textContent = `${currentUser.email} • ${currentUser.role}${dealerTxt}${badge}`; info.classList.remove('d-none'); }
      out?.classList.remove('d-none');
      const isAdmin=currentUser.role==='admin';
      navUsers?.classList.toggle('d-none', !isAdmin);
      if(quick) quick.classList.toggle('d-none', !isAdmin);
    }

    function routeTo(hash){
      if(!currentUser){ showOnly('page-auth'); setActive(''); document.body.classList.remove('page-bg'); return; }
      if(hash==='#/users' && currentUser.role!=='admin'){ hash='#/stock'; }
      if(hash==='#/stock'){
        showOnly('page-dash','page-stock');
        document.body.classList.add('page-bg');
        renderStock(); setActive('#/stock');
        return;
      }
      if(hash==='#/stats'){
        showOnly('page-stats');
        document.body.classList.add('page-bg');
        renderStats(); setActive('#/stats');
        return;
      }
      if(hash==='#/users'){
        showOnly('page-users');
        document.body.classList.add('page-bg');
        renderUsers(); setActive('#/users');
        return;
      }
      showOnly('page-dash','page-stock');
      document.body.classList.add('page-bg');
      renderStock(); setActive('#/stock');
    }
    window.addEventListener('hashchange',()=>routeTo(location.hash));

    // chiave univoca PER OWNER
    function makeKey(finis, complete){
      const f=(finis||'').trim().toLowerCase();
      const c=(complete||'').trim().toLowerCase();
      return `${currentUser.uid}__${f}__${c}`;
    }

    /* Auth + profili */
    async function ensureProfile(uid, email){
      const ref = doc(db, 'profiles', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        const data = { email, role: 'user', dealer: '', disabled: false, createdAt: serverTimestamp() };
        await setDoc(ref, data);
        return data;
      }
      const data = snap.data();
      if (data.dealer === undefined) data.dealer = '';
      if (data.disabled === undefined) data.disabled = false;
      return data;
    }

    function showLoginError(err){
      const box = document.getElementById('authError');
      const map={
        'auth/invalid-email':'Email non valida.',
        'auth/missing-password':'Inserisci la password.',
        'auth/invalid-credential':'Email o password errata.',
        'auth/user-not-found':'Utente non trovato.',
        'auth/wrong-password':'Password errata.',
        'auth/operation-not-allowed':'Abilita Email/Password in Firebase → Authentication.',
        'auth/unauthorized-domain':'Aggiungi il dominio GitHub Pages tra i domini autorizzati.',
        'auth/network-request-failed':'Errore di rete. Riprova.'
      };
      box.textContent = map[err.code] || `Errore di accesso: ${err.code}`;
      box.classList.remove('d-none');
    }

    async function doLogin(email, password){
      const btn = document.getElementById('btnLogin'); const box = document.getElementById('authError');
      box.classList.add('d-none'); box.textContent=''; if(btn) btn.disabled=true;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const prof = await ensureProfile(cred.user.uid, cred.user.email || email);
        if (prof.disabled === true) { await signOut(auth); box.textContent = 'Account bloccato. Contatta un amministratore.'; box.classList.remove('d-none'); return; }
        currentUser = { uid: cred.user.uid, email: cred.user.email || email, role: prof.role, dealer: prof.dealer || '', disabled: !!prof.disabled };
        renderNav(); routeTo(location.hash || '#/stock'); await refreshAll();
      } catch(err){ console.error('LOGIN ERROR:', err.code, err.message); showLoginError(err); }
      finally { if(btn) btn.disabled=false; }
    }
    async function doLogout(){ await signOut(auth); currentUser=null; renderNav(); showOnly('page-auth'); }

    onAuthStateChanged(auth, async (u)=>{
      if(!u){ currentUser=null; renderNav(); showOnly('page-auth'); return; }
      const prof = await ensureProfile(u.uid, u.email);
      if (prof.disabled === true) { await signOut(auth); return; }
      currentUser = { uid: u.uid, email: u.email, role: prof.role, dealer: prof.dealer || '', disabled: !!prof.disabled };
      renderNav(); routeTo(location.hash || '#/stock'); await refreshAll();
    });
    async function exportStock(){
      try{
        const ownerSel = document.getElementById('filterOwner')?.value;
        const text = document.getElementById('search')?.value;
        const rows = visibleItems(text, ownerSel);
        if(!rows.length){ alert('Nessun dato da esportare.'); return; }
        // Prepara dati tabellari ordinati
        const isAdmin = (currentUser?.role==='admin');
        const data = rows.map(r=>({
          'Finis': r.finis||'',
          'Complete': r.complete||'',
          'Descrizione': r.desc||'',
          'Note': r.note||'',
          'Qty': Number(r.qty||0),
          ...(isAdmin ? {'Dealer': (profilesMap.get(r.ownerUid)?.dealer)||r.ownerEmail||''} : {})
        }));
        const ws = XLSX.utils.json_to_sheet(data, {header: Object.keys(data[0])});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Stock');
        // Larghezze colonne auto (semplice)
        const colWidths = Object.keys(data[0]).map(k=>({wch: Math.min(30, Math.max(k.length, ...data.map(d=>String(d[k]||'').length)))}));
        ws['!cols'] = colWidths;
        const ts = new Date();
        const pad=n=>String(n).padStart(2,'0');
        const fname = `StockApp_export_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.xlsx`;
        XLSX.writeFile(wb, fname);
      }catch(err){ console.error('EXPORT ERROR:', err); alert('Errore durante l\'export'); }
    }

    async function fetchItems(){
      if(!currentUser) return;
      let qRef;
      if(currentUser.role==='admin') qRef = query(collection(db,'items'), orderBy('createdAt','desc'));
      else qRef = query(collection(db,'items'), where('ownerUid','==',currentUser.uid), orderBy('createdAt','desc'));
      const snap = await getDocs(qRef);
      itemsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));

      if(currentUser.role==='admin'){
        const ps = await getDocs(collection(db,'profiles'));
        profilesMap = new Map(ps.docs.map(d=>[d.id, d.data()]));
      }
      renderStock(); renderStats();
    }

async function addItem(){
  const finis    = document.getElementById('newFinis').value.trim();
  const complete = document.getElementById('newComplete').value.trim();
  const desc     = document.getElementById('newDesc').value.trim();
  const note     = document.getElementById('newNote').value.trim();
  if(!finis && !complete){ alert('Inserisci almeno Finis o Complete'); return; }

  // check duplicato locale (niente getDoc su Firestore)
  const f = (finis||'').toLowerCase(), c = (complete||'').toLowerCase();
  const dup = itemsCache.some(it =>
    it.ownerUid === currentUser.uid &&
    (it.finis||'').toLowerCase() === f &&
    (it.complete||'').toLowerCase() === c
  );
  if (dup) { alert('Hai già un record con lo stesso Finis e Complete.'); return; }

  const key = `${currentUser.uid}__${f}__${c}`;
  await setDoc(doc(db,'items',key), {
    key, ownerUid: currentUser.uid, ownerEmail: currentUser.email,
    finis, complete, desc, note, qty: 0, createdAt: serverTimestamp()
  });

  ['newFinis','newComplete','newDesc','newNote'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  await fetchItems();
}


    async function moveItem(id, delta){
      const ref = doc(db,'items',id);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref); if(!snap.exists()) return;
        const it = snap.data();
        if(currentUser.role!=='admin' && it.ownerUid!==currentUser.uid) throw new Error('Non autorizzato');
        const next = Math.max(0, Number(it.qty||0)+Number(delta||0));
        tx.update(ref, { qty: next });
      });
      await fetchItems();
    }

    async function deleteItem(id){
      if(!confirm('Eliminare definitivamente il record?')) return;
      const ref = doc(db,'items', id);
      try{
        const snap = await getDoc(ref);
        if(!snap.exists()){ await fetchItems(); return; }
        const it = snap.data();
        if(currentUser.role!=='admin' && it.ownerUid !== currentUser.uid){ alert('Non sei autorizzato a eliminare questo record.'); return; }
        await deleteDoc(ref);
        await fetchItems();
      }catch(err){ console.error('DELETE ITEM ERROR:', err.code, err.message); alert(`Errore eliminazione: ${err.code || err.message}`); }
    }

    /* Profili (admin) */
    async function fetchProfiles(){ if(currentUser?.role!=='admin') return []; const snap = await getDocs(collection(db,'profiles')); return snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (a.email||'').localeCompare(b.email||'')); }
    async function setUserRole(uid, role){ if(currentUser?.role!=='admin') return; await updateDoc(doc(db,'profiles',uid), { role }); if(uid===currentUser.uid){ currentUser.role=role; renderNav(); } await renderUsers(); }

    /* Helpers filtri */
    function ownerOptions(selectEl){
      if(!selectEl) return;
      if(currentUser.role!=='admin'){ selectEl.classList.add('d-none'); return; }
      const prev = selectEl.value;
      const owners=[...new Set(itemsCache.map(x=>byEmail(x.ownerEmail)).filter(Boolean))].sort();
      selectEl.innerHTML = `<option value="__auto__">— Filtro Owner (auto) —</option><option value="__all__">Tutti</option>` + owners.map(o=>`<option value="${o}">${o}</option>`).join('');
      if(prev && [...selectEl.options].some(op=>op.value===prev)) selectEl.value = prev;
      selectEl.classList.remove('d-none');
    }
    function visibleItems(text='', ownerSel='__auto__'){
      let arr=itemsCache;
      if(currentUser.role!=='admin'){ arr=arr.filter(r=>byEmail(r.ownerEmail)===byEmail(currentUser.email)); }
      else if(ownerSel && ownerSel!=='__auto__' && ownerSel!=='__all__'){ arr=arr.filter(r=>byEmail(r.ownerEmail)===byEmail(ownerSel)); }
      const q=(text||'').toLowerCase();
      if(q){ arr=arr.filter(r=>(r.finis||'').toLowerCase().includes(q)||(r.complete||'').toLowerCase().includes(q)||(r.desc||'').toLowerCase().includes(q)||(r.note||'').toLowerCase().includes(q)); }
      return arr;
    }
    function metrics(arr){ return { totalItems:arr.length, totalQty:arr.reduce((a,b)=>a+Number(b.qty||0),0) } }

    /* Render Stock */
    function renderStock(){
      if(!currentUser) return;
      const ownerHint=document.getElementById('ownerHint'); if(ownerHint) ownerHint.textContent = currentUser.email;
      ownerOptions(document.getElementById('filterOwner'));
      const list=visibleItems(document.getElementById('search')?.value, document.getElementById('filterOwner')?.value);
      const {totalItems,totalQty}=metrics(list);
      const mI=document.getElementById('metricItems'); if(mI) mI.textContent=totalItems;
      const mQ=document.getElementById('metricQty'); if(mQ) mQ.textContent=totalQty;

      const tbody=document.getElementById('tbody'); if(!tbody) return; tbody.innerHTML='';
      for(const it of list){
        const tr=document.createElement('tr'); tr.dataset.id=it.id;
        const dealerOrEmail = (profilesMap.get(it.ownerUid)?.dealer) || it.ownerEmail || '—';
        tr.innerHTML=`
          <td>${esc(it.finis)}</td>
          <td>${esc(it.complete)}</td>
          <td>${esc(it.desc)}</td>
          <td>${esc(it.note)}</td>
          <td class="text-end">${Number(it.qty||0)}</td>
          <td class="text-end">
            <div class="d-inline-flex align-items-center gap-1">
              <input type="number" min="1" step="1" value="1" class="form-control form-control-sm w-auto" data-qty>
              <button class="btn btn-sm btn-primary" data-action="in" data-id="${it.id}"><i class="bi bi-plus-lg me-1"></i>Carico</button>
              <button class="btn btn-sm btn-outline-light" data-action="out" data-id="${it.id}"><i class="bi bi-dash-lg me-1"></i>Scarico</button>
              <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${it.id}"><i class="bi bi-trash"></i></button>
            </div>
          </td>
          <td id="tdOwner" class="${currentUser.role==='admin'?'':'d-none'}">${esc(dealerOrEmail)}</td>`;
        tbody.appendChild(tr);
      }
      const th=document.getElementById('thOwner'); if(th) th.classList.toggle('d-none', currentUser.role!=='admin');
    }

    /* Render Users (admin) */
    async function renderUsers(){
      if(currentUser?.role!=='admin') return;
      const q=document.getElementById('uSearch')?.value.trim().toLowerCase();
      const rows=(await fetchProfiles()).filter(p=>!q || (p.email||'').toLowerCase().includes(q));
      const uBody=document.getElementById('uBody'); if(!uBody) return; uBody.innerHTML='';
      for(const u of rows){
        const tr=document.createElement('tr'); tr.dataset.uid=u.id;
        const isDisabled = !!u.disabled;
        tr.innerHTML=`
          <td>${esc(u.email||u.id)}</td>
          <td><input class="form-control form-control-sm w-auto d-inline" data-udealer="${esc(u.id)}" value="${esc(u.dealer||'')}" placeholder="Dealer"/></td>
          <td>
            <select class="form-select form-select-sm w-auto d-inline" data-urole="${esc(u.id)}">
              <option value="user" ${u.role==='user'?'selected':''}>User</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
            </select>
          </td>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-udisabled="${esc(u.id)}" ${isDisabled ? 'checked' : ''}>
              <label class="form-check-label">${isDisabled ? 'Bloccato' : 'Attivo'}</label>
            </div>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light me-2" data-action="pwreset" data-email="${esc(u.email||'')}"><i class="bi bi-envelope"></i> Reset password</button>
            <button class="btn btn-sm btn-outline-danger" data-action="deleteUser" data-uid="${esc(u.id)}" ${!isDisabled ? 'disabled title="Blocca prima di eliminare"' : ''}><i class="bi bi-person-x"></i> Elimina</button>
          </td>`;
        uBody.appendChild(tr);
      }
    }

    /* Render Stats */
    function renderStats(){
      if(!currentUser) return;
      const sOwner=document.getElementById('sOwner'); ownerOptions(sOwner);
      // Finis select
      const finisSet=new Set(itemsCache.map(x=>x.finis).filter(Boolean));
      const sFinis=document.getElementById('sFinis');
      const prevF=sFinis?.value || '__all__';
      if(sFinis) sFinis.innerHTML = '<option value="__all__">Tutti i Finis</option>' + [...finisSet].sort().map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join('');
      if(sFinis && [...sFinis.options].some(o=>o.value===prevF)) sFinis.value=prevF; else if(sFinis) sFinis.value='__all__';

      const list=visibleItems(document.getElementById('sSearch')?.value, sOwner?.value);

      // Top codes
      const mapCodes=new Map();
      for(const it of list){ const key=(it.complete||it.finis||'—'); mapCodes.set(key,(mapCodes.get(key)||0)+Number(it.qty||0)); }
      const top=[...mapCodes.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
      const labelsTop=top.map(x=>x[0]); const dataTop=top.map(x=>x[1]);

      // By owner
      const mapOwner=new Map();
      for(const it of list){ const k=it.ownerEmail||'—'; mapOwner.set(k,(mapOwner.get(k)||0)+Number(it.qty||0)); }
      const labelsOwn=[...mapOwner.keys()], dataOwn=[...mapOwner.values()];

      // Time series (ultimi 12 mesi) opzionale su Finis
      const chosenFinis = (document.getElementById('sFinis')?.value)||'__all__';
      const filtered = list.filter(it=> chosenFinis==='__all__' ? true : (it.finis||'')===chosenFinis);
      const now=new Date(); const months=[]; for(let i=11;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; months.push({d,key,label:`${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`}); }
      const sums=new Map(months.map(m=>[m.key,0]));
      for(const it of filtered){ const ts=it.createdAt?.toDate ? it.createdAt.toDate() : (it.createdAt instanceof Date ? it.createdAt : null); if(!ts) continue; const key=`${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}`; if(sums.has(key)) sums.set(key, sums.get(key)+Number(it.qty||0)); }
      const labels=months.map(m=>m.label); const data=months.map(m=>sums.get(m.key)||0);

      if(chartTop) chartTop.destroy(); if(chartOwner) chartOwner.destroy(); if(chartTime) chartTime.destroy();
      chartTop=new Chart(document.getElementById('chartTopCodes'),{type:'bar',data:{labels:labelsTop,datasets:[{label:'Qty',data:dataTop}]},options:{plugins:{legend:{display:false}}}});
      chartOwner=new Chart(document.getElementById('chartByOwner'),{type:'pie',data:{labels:labelsOwn,datasets:[{label:'Qty',data:dataOwn}]}});
      chartTime=new Chart(document.getElementById('chartQtyTime'),{type:'line',data:{labels,datasets:[{label:'Qty per mese',data, fill:false, tension:.2}]}, options:{plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}});
    }

    /* Event wiring */
    function bindEvents(){
      // Export
      document.getElementById('btnExport')?.addEventListener('click', exportStock);

      // Login
      const btnLogin = document.getElementById('btnLogin');
      if (btnLogin) btnLogin.addEventListener('click', () => doLogin(document.getElementById('email').value.trim(), document.getElementById('password').value));
      const onEnter = e => { if (e.key === 'Enter') btnLogin?.click(); };
      document.getElementById('email')?.addEventListener('keydown', onEnter);
      document.getElementById('password')?.addEventListener('keydown', onEnter);
      document.getElementById('btnLogout')?.addEventListener('click', doLogout);

      // Stock
      document.getElementById('search')?.addEventListener('input', renderStock);
      document.getElementById('filterOwner')?.addEventListener('change', renderStock);
      document.getElementById('btnAdd')?.addEventListener('click', addItem);
      const tbody = document.getElementById('tbody');
      if (tbody) {
        tbody.addEventListener('click', e => {
          const b = e.target.closest('button[data-action]'); if (!b) return;
          const tr = b.closest('tr'); const id = b.dataset.id || tr?.dataset?.id;
          let v = parseInt(tr.querySelector('[data-qty]')?.value || '1', 10);
          if (!Number.isFinite(v) || v < 1) v = 1;
          if (b.dataset.action === 'in')  moveItem(id, +v);
          if (b.dataset.action === 'out') moveItem(id, -v);
          if (b.dataset.action === 'del') deleteItem(id);
        });
      }

      // Users (admin)
      const btnCreate = document.getElementById('btnCreateUser');
      if (btnCreate) {
        btnCreate.addEventListener('click', async () => {
          if (currentUser?.role !== 'admin') return;
          const email  = document.getElementById('uNewEmail').value.trim();
          const pass   = document.getElementById('uNewPassword').value.trim();
          const role   = document.getElementById('uNewRole').value;
          const dealer = document.getElementById('uNewDealer').value.trim();
          const msgEl  = document.getElementById('uMsg'); msgEl.textContent = '';
          if (!email || !pass) { msgEl.textContent = 'Email e password sono obbligatorie.'; return; }
          try {
            const secondary = initializeApp(firebaseConfig, 'secondary');
            const secondaryAuth = getAuth(secondary);
            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
            await setDoc(doc(db,'profiles',cred.user.uid), { email, role, dealer: dealer||'', disabled:false, createdAt: serverTimestamp() });
            msgEl.textContent = `Utente creato: ${email}`;
          } catch (err) {
            console.error(err); msgEl.textContent = `Errore creazione: ${err.code}`;
          } finally {
            try { await deleteApp(getApp('secondary')); } catch(_) {}
            ['uNewEmail','uNewPassword','uNewDealer'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
            const r = document.getElementById('uNewRole'); if (r) r.value='user';
            await renderUsers();
          }
        });
      }

      const uBody = document.getElementById('uBody');
      if (uBody) {
        uBody.addEventListener('change', async e => {
          const sel = e.target.closest('select[data-urole]');
          if (sel) { await setUserRole(sel.dataset.urole, sel.value); return; }
          const chk = e.target.closest('input[data-udisabled]');
          if (chk) {
            const uid = chk.dataset.udisabled;
            try {
              await updateDoc(doc(db,'profiles',uid), { disabled: chk.checked });
              try { if (fnSetDisabled) await fnSetDisabled({ uid, disabled: chk.checked }); } catch(_) {}
              const row = chk.closest('tr'); row.querySelector('.form-check-label').textContent = chk.checked ? 'Bloccato' : 'Attivo';
              const delBtn=row.querySelector('button[data-action="deleteUser"]'); if(delBtn){ delBtn.disabled=!chk.checked; delBtn.title = chk.checked ? '' : 'Blocca prima di eliminare'; }
            } catch (err) { console.error(err); alert('Permesso negato'); chk.checked = !chk.checked; }
          }
        });
        uBody.addEventListener('input', async e => {
          const inp = e.target.closest('input[data-udealer]'); if (!inp) return;
          const uid = inp.dataset.udealer; clearTimeout(inp._t);
          inp._t = setTimeout(async () => {
            try { await updateDoc(doc(db,'profiles',uid), { dealer: inp.value.trim() }); }
            catch (err) { console.error(err); alert('Impossibile aggiornare Dealer'); }
          }, 400);
        });
        uBody.addEventListener('click', async e => {
          const b = e.target.closest('button[data-action]'); if (!b) return;
          if (b.dataset.action === 'pwreset') {
            const email = b.dataset.email;
            try { await sendPasswordResetEmail(auth, email); alert(`Email inviata a: ${email}`); }
            catch (err) { console.error(err); alert(`Errore: ${err.code}`); }
            return;
          }
          if (b.dataset.action === 'deleteUser') {
            const uid = b.dataset.uid; if (!confirm('Eliminare definitivamente questa utenza?')) return;
            try {
              try { if (fnDeleteUser) await fnDeleteUser({ uid }); } catch (_) {}
              await deleteDoc(doc(db,'profiles',uid)); await renderUsers();
              alert('Utenza eliminata.');
            } catch (err) { console.error(err); alert(`Errore: ${err.message||err}`); }
          }
        });
      }

      // Stats
      document.getElementById('sApply')?.addEventListener('click', renderStats);
      document.getElementById('sFinis')?.addEventListener('change', renderStats);
    }

    async function fetchProfilesIntoMap(){ const ps = await getDocs(collection(db,'profiles')); profilesMap = new Map(ps.docs.map(d=>[d.id, d.data()])); }
    async function refreshAll(){ await fetchItems(); if(currentUser?.role==='admin') await fetchProfilesIntoMap(); renderStats(); }

    // Start
    bindEvents();
    showOnly('page-auth');
  </script>
</body>
</html>
