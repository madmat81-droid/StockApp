<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StockApp</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0c10;--panel:#131622;--muted:#9aa3af;--border:#1f2330;--primary:#3b82f6;--accent:#10b981;}
body{background:var(--bg);color:#e8eaee}
.navbar{background:#0f121b}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px}
.metric{font-size:2.2rem;font-weight:700}
.form-control,.form-select{background:#0e1220;color:#e8eaee;border-color:#1e2432}
.form-control:focus{box-shadow:none;border-color:var(--primary)}
.btn-primary{background:var(--primary);border-color:var(--primary)}
.btn-success{background:var(--accent);border-color:var(--accent)}
.table-dark{--bs-table-bg:#111425;--bs-table-striped-bg:#0e1120}
.badge-role{background:#1c2231}
.muted{color:var(--muted)}
a.nav-link{color:#bfc6d4}
a.nav-link.active{color:#fff}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#/stock"><i class="bi bi-box-seam me-2"></i>StockApp</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navCollapse" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto ms-3 gap-2">
        <li class="nav-item"><a class="nav-link" href="#/stock"><i class="bi bi-grid-3x3-gap me-1"></i>Stock</a></li>
        <li class="nav-item"><a class="nav-link" href="#/stats"><i class="bi bi-graph-up me-1"></i>Statistiche</a></li>
        <li class="nav-item d-none" id="navUsers"><a class="nav-link" href="#/users"><i class="bi bi-people me-1"></i>Utenti</a></li>
      </ul>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
        <button id="btnLogout" class="btn btn-sm btn-outline-light d-none" type="button">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">

  <!-- LOGIN -->
  <section id="page-auth" class="card mb-4">
    <div class="card-body">
      <h3 class="h5 mb-3">Accesso</h3>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" autocomplete="current-password" placeholder="••••••"/>
        </div>
        <div class="col-md-4">
          <button id="btnLogin" class="btn btn-primary w-100" type="button">
            <i class="bi bi-box-arrow-in-right me-1"></i>Entra
          </button>
          <small class="muted d-block mt-2">
            Gli utenti si creano in <strong>Firebase → Authentication</strong>. I ruoli si impostano in <strong>Firestore → profiles</strong>.
          </small>
        </div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="page-dash" class="row g-3 d-none">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body d-flex align-items-center">
        <div class="me-auto">
          <h5 class="card-title mb-1">Articoli</h5><div class="muted small">Record visibili</div>
        </div>
        <div id="metricItems" class="metric">0</div>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body d-flex align-items-center">
        <div class="me-auto">
          <h5 class="card-title mb-1">Giacenza totale</h5><div class="muted small">Somma Qty visibili</div>
        </div>
        <div id="metricQty" class="metric">0</div>
      </div></div>
    </div>
  </section>

  <!-- STOCK -->
  <section id="page-stock" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Magazzino</h3>
        <input id="search" class="form-control" placeholder="Cerca Finis/Complete/Descrizione/Note" style="max-width:380px"/>
        <select id="filterOwner" class="form-select d-none" style="max-width:220px"></select>
        <a id="quickUsers" href="#/users" class="btn btn-outline-light d-none"><i class="bi bi-people me-1"></i>Gestisci utenti</a>
      </div>

      <div class="mb-3">
        <div class="row g-2">
          <div class="col-lg-2"><input id="newFinis" class="form-control" placeholder="Finis Code"/></div>
          <div class="col-lg-2"><input id="newComplete" class="form-control" placeholder="Complete Code"/></div>
          <div class="col-lg-3"><input id="newDesc" class="form-control" placeholder="Descrizione"/></div>
          <div class="col-lg-3"><input id="newNote" class="form-control" placeholder="Note"/></div>
          <div class="col-lg-2 d-grid"><button id="btnAdd" class="btn btn-success" type="button"><i class="bi bi-plus-lg me-1"></i>Aggiungi</button></div>
        </div>
        <div class="muted small mt-1">I nuovi record saranno di: <span id="ownerHint">—</span></div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Finis</th>
              <th>Complete</th>
              <th>Descrizione</th>
              <th>Note</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Azioni</th>
              <th id="thOwner" class="d-none">Owner</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- USERS (ADMIN) -->
  <section id="page-users" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Gestione Utenti</h3>
        <input id="uSearch" class="form-control" placeholder="Cerca email" style="max-width:320px"/>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead><tr><th>Email</th><th>Ruolo</th><th class="text-end">Azioni</th></tr></thead>
          <tbody id="uBody"></tbody>
        </table>
      </div>
      <div class="muted small">Gli utenti si aggiungono/eliminano da <strong>Authentication</strong>. Qui gestisci <strong>solo i ruoli</strong>.</div>
    </div>
  </section>

  <!-- STATS -->
  <section id="page-stats" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Statistiche</h3>
        <input id="sSearch" class="form-control" placeholder="Filtro testo" style="max-width:340px"/>
        <select id="sOwner" class="form-select" style="max-width:220px"></select>
        <button id="sApply" class="btn btn-primary" type="button"><i class="bi bi-funnel me-1"></i>Applica</button>
      </div>
      <div class="row g-4">
        <div class="col-12"><div class="card"><div class="card-body">
          <h6 class="mb-2">Top codici per Qty</h6>
          <canvas id="chartTopCodes" height="120"></canvas>
        </div></div></div>
        <div class="col-12"><div class="card"><div class="card-body">
          <h6 class="mb-2">Distribuzione Qty per Owner</h6>
          <canvas id="chartByOwner" height="120"></canvas>
        </div></div></div>
      </div>
    </div>
  </section>

</main>

<!-- ===== APP (Firebase) ===== -->
<script type="module">
/* --- Firebase SDK --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, query, where, orderBy, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/* --- INCOLLA QUI LA TUA CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyABezXPgHhyvPknItXGyuvA-vKozNw6_qw",
  authDomain: "stockappdb-2420d.firebaseapp.com",
  projectId: "stockappdb-2420d",
  messagingSenderId: "856091877639",
  storageBucket: "stockappdb-2420d.appspot.com"
  // appId è facoltativo per la nostra SPA; se la console te lo mostra, puoi aggiungerlo qui.
};
/* ---------------------------------- */

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* --- Stato --- */
let currentUser = null;        // { uid, email, role }
let itemsCache  = [];          // [{id,...}]
let charts = { top:null, owner:null };

const $ = (s)=>document.querySelector(s);
const $$= (s)=>document.querySelectorAll(s);
const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}));
const byEmail = e => (e||'').trim().toLowerCase();

/* --- Auth + profili --- */
async function ensureProfile(uid, email){
  const ref = doc(db, "profiles", uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref, { email, role:"user", createdAt: serverTimestamp() });
    return { email, role:"user" };
  }
  return snap.data();
}
async function doLogin(email, password){
  const cred = await signInWithEmailAndPassword(auth, email, password);
  const prof = await ensureProfile(cred.user.uid, cred.user.email || email);
  currentUser = { uid: cred.user.uid, email: cred.user.email || email, role: prof.role };
  renderNav(); routeTo(location.hash || "#/stock"); await refreshAll();
}
async function doLogout(){ await signOut(auth); currentUser=null; renderNav(); showOnly('page-auth'); }

onAuthStateChanged(auth, async u=>{
  if(!u){ currentUser=null; renderNav(); showOnly('page-auth'); return; }
  const prof = await ensureProfile(u.uid, u.email);
  currentUser = { uid: u.uid, email: u.email, role: prof.role };
  renderNav(); routeTo(location.hash || "#/stock"); await refreshAll();
});

/* --- Items --- */
async function fetchItems(){
  if(!currentUser) return;
  let qRef;
  if(currentUser.role==='admin'){
    qRef = query(collection(db,"items"), orderBy("createdAt","desc"));
  } else {
    qRef = query(collection(db,"items"), where("ownerUid","==",currentUser.uid), orderBy("createdAt","desc"));
  }
  const snap = await getDocs(qRef);
  itemsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderStock(); renderStats();
}
async function addItem(){
  const finis=$('#newFinis').value.trim();
  const complete=$('#newComplete').value.trim();
  const desc=$('#newDesc').value.trim();
  const note=$('#newNote').value.trim();
  if(!finis && !complete){ alert('Inserisci almeno Finis o Complete'); return; }
  await addDoc(collection(db,"items"), {
    ownerUid: currentUser.uid, ownerEmail: currentUser.email,
    finis, complete, desc, note, qty: 0, createdAt: serverTimestamp()
  });
  ['#newFinis','#newComplete','#newDesc','#newNote'].forEach(s=>$(s).value='');
  await fetchItems();
}
async function moveItem(id, delta){
  const ref = doc(db,"items",id);
  await runTransaction(db, async tx=>{
    const snap = await tx.get(ref); if(!snap.exists()) return;
    const it = snap.data();
    if(currentUser.role!=='admin' && it.ownerUid!==currentUser.uid) throw new Error('Non autorizzato');
    const next = Math.max(0, Number(it.qty||0)+Number(delta||0));
    tx.update(ref, { qty: next });
  });
  await fetchItems();
}

/* --- Profili (admin) --- */
async function fetchProfiles(){
  if(currentUser?.role!=='admin') return [];
  const snap = await getDocs(collection(db,"profiles"));
  return snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (a.email||'').localeCompare(b.email||''));
}
async function setUserRole(uid, role){
  if(currentUser?.role!=='admin') return;
  await updateDoc(doc(db,"profiles",uid), { role });
  if(uid===currentUser.uid){ currentUser.role=role; renderNav(); } // se cambio me stesso
  await renderUsers();
}

/* --- Router/UI comuni --- */
function renderNav(){
  const info=$('#userInfo'), out=$('#btnLogout'), navUsers=$('#navUsers'), quick=$('#quickUsers');
  if(!currentUser){ info.classList.add('d-none'); out.classList.add('d-none'); navUsers.classList.add('d-none'); quick.classList.add('d-none'); return; }
  info.textContent = `${currentUser.email} • ${currentUser.role}`;
  info.classList.remove('d-none'); out.classList.remove('d-none');
  const isAdmin=currentUser.role==='admin';
  navUsers.classList.toggle('d-none', !isAdmin);
  quick.classList.toggle('d-none', !isAdmin);
}
function setActive(hash){ $$('.nav-link').forEach(a=>a.classList.remove('active')); const l=document.querySelector(`.nav-link[href="${hash}"]`); if(l) l.classList.add('active'); }
function showOnly(...ids){ ['page-auth','page-dash','page-stock','page-users','page-stats'].forEach(id=>$('#'+id).classList.add('d-none')); ids.forEach(id=>$('#'+id).classList.remove('d-none')); }
function routeTo(hash){
  if(!currentUser){ showOnly('page-auth'); setActive(''); return; }
  if(hash==='#/users' && currentUser.role!=='admin'){ hash='#/stock'; }
  if(hash==='#/stock'){ showOnly('page-dash','page-stock'); renderStock(); setActive('#/stock'); }
  if(hash==='#/stats'){ showOnly('page-stats'); renderStats(); setActive('#/stats'); }
  if(hash==='#/users'){ showOnly('page-users'); renderUsers(); setActive('#/users'); }
}
window.addEventListener('hashchange',()=>routeTo(location.hash));
async function refreshAll(){ await fetchItems(); await renderUsers(); renderStats(); }

/* --- Helpers dati/filtri --- */
function ownerOptions(selectEl){
  if(currentUser.role!=='admin'){ selectEl.classList.add('d-none'); return; }
  const owners=[...new Set(itemsCache.map(x=>byEmail(x.ownerEmail)).filter(Boolean))].sort();
  selectEl.innerHTML=`<option value="__auto__">— Filtro Owner (auto) —</option><option value="__all__">Tutti</option>` + owners.map(o=>`<option value="${o}">${o}</option>`).join('');
  selectEl.classList.remove('d-none');
}
function visibleItems(text='', ownerSel='__auto__'){
  let arr=itemsCache;
  if(currentUser.role!=='admin'){ arr=arr.filter(r=>byEmail(r.ownerEmail)===byEmail(currentUser.email)); }
  else if(ownerSel && ownerSel!=='__auto__' && ownerSel!=='__all__'){ arr=arr.filter(r=>byEmail(r.ownerEmail)===byEmail(ownerSel)); }
  const q=(text||'').toLowerCase();
  if(q){ arr=arr.filter(r=>(r.finis||'').toLowerCase().includes(q)||(r.complete||'').toLowerCase().includes(q)||(r.desc||'').toLowerCase().includes(q)||(r.note||'').toLowerCase().includes(q)); }
  return arr;
}
function metrics(arr){return{ totalItems:arr.length, totalQty:arr.reduce((a,b)=>a+Number(b.qty||0),0) }}

/* --- Render Stock --- */
function renderStock(){
  if(!currentUser) return;
  $('#ownerHint').textContent=currentUser.email;
  ownerOptions($('#filterOwner'));
  const list=visibleItems($('#search').value, $('#filterOwner').value);
  const {totalItems,totalQty}=metrics(list);
  $('#metricItems').textContent=totalItems; $('#metricQty').textContent=totalQty;

  const tbody=$('#tbody'); tbody.innerHTML='';
  for(const it of list){
    const tr=document.createElement('tr'); tr.dataset.id=it.id;
    tr.innerHTML=`
      <td>${esc(it.finis)}</td>
      <td>${esc(it.complete)}</td>
      <td>${esc(it.desc)}</td>
      <td>${esc(it.note)}</td>
      <td class="text-end">${Number(it.qty||0)}</td>
      <td class="text-end">
        <div class="d-inline-flex align-items-center gap-1">
          <input type="number" min="1" step="1" value="1" class="form-control form-control-sm w-auto" data-qty>
          <button class="btn btn-sm btn-primary" data-action="in" data-id="${it.id}"><i class="bi bi-plus-lg me-1"></i>Carico</button>
          <button class="btn btn-sm btn-outline-light" data-action="out" data-id="${it.id}"><i class="bi bi-dash-lg me-1"></i>Scarico</button>
        </div>
      </td>
      <td id="tdOwner" class="${currentUser.role==='admin'?'':'d-none'}">${esc(it.ownerEmail)}</td>`;
    tbody.appendChild(tr);
  }
  $('#thOwner').classList.toggle('d-none', currentUser.role!=='admin');
}

/* --- Render Users (admin) --- */
async function renderUsers(){
  if(currentUser?.role!=='admin') return;
  const q=$('#uSearch').value.trim().toLowerCase();
  const rows=(await fetchProfiles()).filter(p=>!q || (p.email||'').toLowerCase().includes(q));
  const uBody=$('#uBody'); uBody.innerHTML='';
  for(const u of rows){
    const tr=document.createElement('tr'); tr.dataset.uid=u.id;
    tr.innerHTML=`
      <td>${esc(u.email||u.id)}</td>
      <td>
        <select class="form-select form-select-sm w-auto d-inline" data-urole="${esc(u.id)}">
          <option value="user" ${u.role==='user'?'selected':''}>User</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
        </select>
      </td>
      <td class="text-end"><span class="muted small">Password: da Firebase Console</span></td>`;
    uBody.appendChild(tr);
  }
}

/* --- Render Stats --- */
let chartTop=null, chartOwner=null;
function renderStats(){
  if(!currentUser) return;
  // owner filter (admin)
  const sOwner=$('#sOwner'); ownerOptions(sOwner);
  const list=visibleItems($('#sSearch').value, sOwner.value);

  // top codes
  const m=new Map();
  for(const it of list){ const key=(it.complete||it.finis||'—'); m.set(key,(m.get(key)||0)+Number(it.qty||0)); }
  const top=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
  const labelsTop=top.map(x=>x[0]); const dataTop=top.map(x=>x[1]);

  // by owner
  const mo=new Map();
  for(const it of list){ const k=it.ownerEmail||'—'; mo.set(k,(mo.get(k)||0)+Number(it.qty||0)); }
  const labelsOwn=[...mo.keys()], dataOwn=[...mo.values()];

  if(chartTop) chartTop.destroy(); if(chartOwner) chartOwner.destroy();
  chartTop=new Chart($('#chartTopCodes'),{type:'bar',data:{labels:labelsTop,datasets:[{label:'Qty',data:dataTop}]},options:{plugins:{legend:{display:false}}}});
  chartOwner=new Chart($('#chartByOwner'),{type:'pie',data:{labels:labelsOwn,datasets:[{label:'Qty',data:dataOwn}]}})
}

/* --- Event wiring --- */
$('#btnLogin').addEventListener('click',()=>doLogin($('#email').value,$('#password').value));
$('#btnLogout').addEventListener('click',doLogout);
window.addEventListener('hashchange',()=>routeTo(location.hash));

$('#search').addEventListener('input',renderStock);
$('#filterOwner').addEventListener('change',renderStock);
$('#btnAdd').addEventListener('click',addItem);
$('#tbody').addEventListener('click',e=>{
  const b=e.target.closest('button[data-action]'); if(!b) return;
  const tr=b.closest('tr'); const id=b.dataset.id||tr?.dataset?.id;
  let v=Number(tr.querySelector('[data-qty]')?.value||1); if(!Number.isFinite(v)||v<1) v=1;
  if(b.dataset.action==='in')  moveItem(id,+v);
  if(b.dataset.action==='out') moveItem(id,-v);
});

$('#uSearch').addEventListener('input',renderUsers);
document.getElementById('uBody').addEventListener('change',async e=>{
  const sel=e.target.closest('select[data-urole]'); if(!sel) return;
  await setUserRole(sel.getAttribute('data-urole'), sel.value);
});

$('#sApply').addEventListener('click',renderStats);

// start: mostra login, il resto parte su onAuthStateChanged
document.getElementById('page-auth').classList.remove('d-none');
</script>
</body>
</html>
