<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StockApp (Static SPA)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0a0c10; --panel:#131622; --muted:#9aa3af;
  --border:#1f2330; --primary:#3b82f6; --accent:#10b981;
}
body{background:var(--bg); color:#e8eaee}
.navbar{background:#0f121b}
.card{background:var(--panel); border:1px solid var(--border); border-radius:16px}
.metric{font-size:2.4rem; font-weight:700}
.form-control,.form-select{background:#0e1220;color:#e8eaee;border-color:#1e2432}
.form-control:focus{box-shadow:none;border-color:var(--primary)}
.btn-primary{background:var(--primary); border-color:var(--primary)}
.btn-success{background:var(--accent); border-color:var(--accent)}
.table-dark{--bs-table-bg:#111425; --bs-table-striped-bg:#0e1120}
.badge-role{background:#1c2231}
.muted{color:var(--muted)}
a.nav-link{color:#bfc6d4}
a.nav-link.active{color:#fff}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#/stock"><i class="bi bi-box-seam me-2"></i>StockApp</a>
    <ul class="navbar-nav me-auto ms-3 gap-2" id="mainNav">
      <li class="nav-item"><a class="nav-link" href="#/stock"><i class="bi bi-grid-3x3-gap me-1"></i>Stock</a></li>
      <li class="nav-item"><a class="nav-link" href="#/stats"><i class="bi bi-graph-up me-1"></i>Statistiche</a></li>
      <li class="nav-item d-none" id="navUsers"><a class="nav-link" href="#/users"><i class="bi bi-people me-1"></i>Utenti</a></li>
    </ul>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light d-none" type="button">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-4">

  <!-- AUTH -->
  <section id="page-auth" class="card mb-4 d-none">
    <div class="card-body">
      <h3 class="h5 mb-3">Accesso</h3>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" placeholder="admin@example.com" autocomplete="username"/>
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" placeholder="••••••" autocomplete="current-password"/>
        </div>
        <div class="col-md-4">
          <button id="btnLogin" class="btn btn-primary w-100" type="button"><i class="bi bi-box-arrow-in-right me-1"></i>Entra</button>
          <small class="muted d-block mt-2">
            Admin → <code>admin@example.com / admin</code> · User → <code>user1@example.com / user</code>
          </small>
        </div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD (top) -->
  <section id="page-dash" class="row g-3 d-none">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto"><h5 class="card-title mb-1">Articoli</h5><div class="muted small">Record visibili</div></div>
          <div id="metricItems" class="metric">0</div>
        </div>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto"><h5 class="card-title mb-1">Giacenza totale</h5><div class="muted small">Somma Qty visibili</div></div>
          <div id="metricQty" class="metric">0</div>
        </div>
      </div></div>
    </div>
  </section>

  <!-- PAGE: STOCK -->
  <section id="page-stock" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Magazzino</h3>
        <input id="search" class="form-control" placeholder="Cerca Finis/Complete/Descrizione/Note" style="max-width:380px"/>
        <select id="filterOwner" class="form-select d-none" style="max-width:220px"></select>
      </div>

      <div id="addBar" class="mb-3">
        <div class="row g-2">
          <div class="col-lg-2"><input id="newFinis" class="form-control" placeholder="Finis Code"/></div>
          <div class="col-lg-2"><input id="newComplete" class="form-control" placeholder="Complete Code"/></div>
          <div class="col-lg-3"><input id="newDesc" class="form-control" placeholder="Descrizione"/></div>
          <div class="col-lg-3"><input id="newNote" class="form-control" placeholder="Note"/></div>
          <div class="col-lg-2 d-grid"><button id="btnAdd" class="btn btn-success" type="button"><i class="bi bi-plus-lg me-1"></i>Aggiungi</button></div>
        </div>
        <div class="muted small mt-1">I nuovi record saranno di: <span id="ownerHint"></span></div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Finis</th>
              <th>Complete</th>
              <th>Descrizione</th>
              <th>Note</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Azioni</th>
              <th id="thOwner" class="d-none">Owner</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-light" type="button"><i class="bi bi-download me-1"></i>Esporta JSON</button>
        <label class="btn btn-outline-light mb-0"><i class="bi bi-upload me-1"></i>Importa JSON <input id="fileImport" type="file" accept="application/json" hidden></label>
      </div>
      <div class="muted small mt-2">Dati salvati nel browser (localStorage). Visibilità per owner.</div>
    </div>
  </section>

  <!-- PAGE: USERS (ADMIN) -->
  <section id="page-users" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Gestione Utenti</h3>
        <input id="uSearch" class="form-control" placeholder="Cerca email" style="max-width:320px"/>
      </div>
      <div class="row g-2 mb-3">
        <div class="col-lg-4"><input id="uEmail" class="form-control" placeholder="email@dominio.it"/></div>
        <div class="col-lg-3"><input id="uPassword" class="form-control" placeholder="password"/></div>
        <div class="col-lg-3">
          <select id="uRole" class="form-select"><option value="user">User</option><option value="admin">Admin</option></select>
        </div>
        <div class="col-lg-2 d-grid"><button id="btnAddUser" class="btn btn-success" type="button"><i class="bi bi-person-plus me-1"></i>Aggiungi</button></div>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead><tr><th>Email</th><th>Ruolo</th><th class="text-end">Azioni</th></tr></thead>
          <tbody id="uBody"></tbody>
        </table>
      </div>
      <div class="muted small">⚠️ Demo: utenti in localStorage.</div>
    </div>
  </section>

  <!-- PAGE: STATS -->
  <section id="page-stats" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Statistiche</h3>
        <input id="sSearch" class="form-control" placeholder="Filtro testo (Finis/Complete/Desc/Note)" style="max-width:340px"/>
        <select id="sOwner" class="form-select" style="max-width:220px"></select>
        <button id="sApply" class="btn btn-primary" type="button"><i class="bi bi-funnel me-1"></i>Applica</button>
      </div>
      <div class="row g-4">
        <div class="col-12">
          <div class="card"><div class="card-body">
            <h6 class="mb-2">Top codici per Qty (Bar)</h6>
            <canvas id="chartTopCodes" height="120"></canvas>
          </div></div>
        </div>
        <div class="col-12">
          <div class="card"><div class="card-body">
            <h6 class="mb-2">Distribuzione Qty per Owner (Pie)</h6>
            <canvas id="chartByOwner" height="120"></canvas>
          </div></div>
        </div>
      </div>
      <div class="muted small mt-2">I grafici rispettano visibilità/ruoli: gli User vedono i propri dati; gli Admin possono filtrare per Owner o “Tutti”.</div>
    </div>
  </section>

</main>

<script type="module">
/* ===== STATE & STORAGE ===== */
const LS_ITEMS='stockapp.items.v4';
const LS_USERS='stockapp.users.v1';
let state={user:null,items:[],users:[]};
const uid=()=>Math.random().toString(36).slice(2,10);
const byEmail=e=>(e||'').trim().toLowerCase();
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function loadItems(){try{state.items=JSON.parse(localStorage.getItem(LS_ITEMS)||'[]');}catch{state.items=[];}}
function saveItems(){localStorage.setItem(LS_ITEMS,JSON.stringify(state.items));}
function loadUsers(){try{state.users=JSON.parse(localStorage.getItem(LS_USERS)||'[]');}catch{state.users=[];}}
function saveUsers(){localStorage.setItem(LS_USERS,JSON.stringify(state.users));}
function ensureSeedUsers(){
  loadUsers();
  if(state.users.length===0){
    state.users=[{email:'admin@example.com',pass:'admin',role:'admin'},{email:'user1@example.com',pass:'user',role:'user'}];
    saveUsers();
  }
}

/* ===== AUTH ===== */
function login(email,pw){
  ensureSeedUsers();
  const u=state.users.find(x=>byEmail(x.email)===byEmail(email));
  if(!u || u.pass!==pw){alert('Credenziali non valide');return;}
  state.user={email:u.email,role:u.role};
  loadItems();
  routeTo(location.hash||'#/stock');
  renderNav();
}
function logout(){state.user=null; routeTo('#/stock'); renderNav();}

/* ===== ROUTER ===== */
function show(id){document.querySelectorAll('main > section, #page-dash').forEach(s=>s.classList.add('d-none')); document.querySelectorAll('.nav-link').forEach(a=>a.classList.remove('active')); if(id==='#/stock'){document.getElementById('page-dash').classList.remove('d-none'); document.getElementById('page-stock').classList.remove('d-none'); document.querySelector('a[href=\"#/stock\"]').classList.add('active');} if(id==='#/users'){document.getElementById('page-users').classList.remove('d-none'); document.querySelector('a[href=\"#/users\"]').classList.add('active');} if(id==='#/stats'){document.getElementById('page-stats').classList.remove('d-none'); document.querySelector('a[href=\"#/stats\"]').classList.add('active');}}
function routeTo(hash){
  if(!state.user){document.getElementById('page-auth').classList.remove('d-none'); document.getElementById('page-dash').classList.add('d-none'); document.getElementById('page-stock').classList.add('d-none'); document.getElementById('page-users').classList.add('d-none'); document.getElementById('page-stats').classList.add('d-none'); return;}
  if(hash==='#/users' && state.user.role!=='admin'){location.hash='#/stock'; return;}
  document.getElementById('page-auth').classList.add('d-none');
  show(hash||'#/stock');
  renderAll();
}
window.addEventListener('hashchange',()=>routeTo(location.hash));

function renderNav(){
  const info=document.getElementById('userInfo');
  const out=document.getElementById('btnLogout');
  const navUsers=document.getElementById('navUsers');
  if(!state.user){info.classList.add('d-none'); out.classList.add('d-none'); navUsers.classList.add('d-none'); return;}
  info.classList.remove('d-none'); out.classList.remove('d-none');
  info.textContent=`${state.user.email} • ${state.user.role}`;
  navUsers.classList.toggle('d-none', state.user.role!=='admin');
}

/* ===== DATA VIEW HELPERS ===== */
function visibleItems(filterText='', ownerSel='__auto__'){
  let arr=state.items;
  // owner visibility
  if(state.user.role!=='admin'){
    arr=arr.filter(r=>byEmail(r.owner)===byEmail(state.user.email));
  }else if(ownerSel && ownerSel!=='__auto__' && ownerSel!=='__all__'){
    arr=arr.filter(r=>byEmail(r.owner)===byEmail(ownerSel));
  }
  const q=(filterText||'').toLowerCase();
  if(q){
    arr=arr.filter(r=>
      (r.finis||'').toLowerCase().includes(q) ||
      (r.complete||'').toLowerCase().includes(q) ||
      (r.desc||'').toLowerCase().includes(q) ||
      (r.note||'').toLowerCase().includes(q)
    );
  }
  return arr;
}
function metrics(arr){return {totalItems:arr.length,totalQty:arr.reduce((a,b)=>a+Math.max(0,Number(b.qty||0)),0)}}

function ensureOwnerOptions(selectEl){
  // fill owner filters (admin only)
  if(state.user.role!=='admin'){selectEl.classList.add('d-none'); return;}
  const owners=[...new Set(state.items.map(x=>byEmail(x.owner)).filter(Boolean))].sort();
  selectEl.innerHTML=`<option value="__auto__">— Filtro Owner (auto) —</option><option value="__all__">Tutti</option>`+owners.map(o=>`<option value="${o}">${o}</option>`).join('');
  selectEl.classList.remove('d-none');
}

/* ===== RENDER PAGES ===== */
function renderStock(){
  document.getElementById('ownerHint').textContent=state.user?.email||'-';
  const filterOwner=document.getElementById('filterOwner');
  ensureOwnerOptions(filterOwner);
  const list=visibleItems(document.getElementById('search').value, filterOwner.value);
  const {totalItems,totalQty}=metrics(list);
  document.getElementById('metricItems').textContent=totalItems;
  document.getElementById('metricQty').textContent=totalQty;

  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  for(const it of list){
    const tr=document.createElement('tr'); tr.dataset.id=it.id;
    tr.innerHTML=`
      <td>${esc(it.finis)}</td>
      <td>${esc(it.complete)}</td>
      <td>${esc(it.desc)}</td>
      <td>${esc(it.note)}</td>
      <td class="text-end">${Number(it.qty||0)}</td>
      <td class="text-end">
        <div class="d-inline-flex align-items-center gap-1">
          <input type="number" min="1" step="1" value="1" class="form-control form-control-sm w-auto" data-qty>
          <button class="btn btn-sm btn-primary" data-action="in"  data-id="${it.id}"><i class="bi bi-plus-lg me-1"></i>Carico</button>
          <button class="btn btn-sm btn-outline-light" data-action="out" data-id="${it.id}"><i class="bi bi-dash-lg me-1"></i>Scarico</button>
        </div>
      </td>
      <td class="${state.user.role==='admin'?'':'d-none'}">${esc(it.owner)}</td>`;
    tbody.appendChild(tr);
  }
  // mostra colonna Owner per admin
  document.getElementById('thOwner').classList.toggle('d-none', state.user.role!=='admin');
}
function renderUsers(){
  if(state.user.role!=='admin') return;
  loadUsers();
  const q=document.getElementById('uSearch').value.trim().toLowerCase();
  const rows=state.users.filter(u=>!q||u.email.toLowerCase().includes(q)).sort((a,b)=>a.email.localeCompare(b.email));
  const uBody=document.getElementById('uBody'); uBody.innerHTML='';
  for(const u of rows){
    const tr=document.createElement('tr'); tr.dataset.email=u.email;
    tr.innerHTML=`
      <td>${esc(u.email)}</td>
      <td>
        <select class="form-select form-select-sm w-auto d-inline" data-urole="${esc(u.email)}">
          <option value="user" ${u.role==='user'?'selected':''}>User</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
        </select>
      </td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-light me-1" data-action="reset" data-email="${esc(u.email)}"><i class="bi bi-key"></i> Reset PW</button>
        <button class="btn btn-sm btn-outline-danger" data-action="del" data-email="${esc(u.email)}"><i class="bi bi-trash"></i> Elimina</button>
      </td>`;
    uBody.appendChild(tr);
  }
}
let chartTop=null, chartOwner=null;
function renderStats(){
  // owner options
  ensureOwnerOptions(document.getElementById('sOwner'));
  const list=visibleItems(document.getElementById('sSearch').value, document.getElementById('sOwner').value);

  // aggregate: top codes by qty (use Complete+Finis as label)
  const mapCodes=new Map();
  for(const it of list){
    const key=(it.complete||it.finis||'—');
    mapCodes.set(key, (mapCodes.get(key)||0) + Number(it.qty||0));
  }
  const top=[...mapCodes.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
  const labelsTop=top.map(x=>x[0]); const dataTop=top.map(x=>x[1]);

  // aggregate: qty by owner
  const mapOwner=new Map();
  for(const it of list){
    const key=it.owner||'—';
    mapOwner.set(key, (mapOwner.get(key)||0) + Number(it.qty||0));
  }
  const labelsOwn=[...mapOwner.keys()]; const dataOwn=[...mapOwner.values()];

  // draw charts
  const ctxTop=document.getElementById('chartTopCodes');
  const ctxOwn=document.getElementById('chartByOwner');

  if(chartTop) chartTop.destroy();
  if(chartOwner) chartOwner.destroy();

  chartTop=new Chart(ctxTop,{type:'bar',data:{labels:labelsTop,datasets:[{label:'Qty',data:dataTop}]},options:{responsive:true,plugins:{legend:{display:false}}}});
  chartOwner=new Chart(ctxOwn,{type:'pie',data:{labels:labelsOwn,datasets:[{label:'Qty',data:dataOwn}]},options:{responsive:true}});
}

/* ===== ACTIONS ===== */
function addItem(){
  const finis=document.getElementById('newFinis').value.trim();
  const complete=document.getElementById('newComplete').value.trim();
  const desc=document.getElementById('newDesc').value.trim();
  const note=document.getElementById('newNote').value.trim();
  if(!finis && !complete){alert('Inserisci almeno Finis o Complete Code'); return;}
  state.items.push({id:uid(),owner:state.user.email,finis,complete,desc,note,qty:0,createdAt:Date.now()});
  saveItems();
  ['newFinis','newComplete','newDesc','newNote'].forEach(id=>document.getElementById(id).value='');
  renderStock(); renderStats(); // aggiornare anche stats
}
function moveItem(id,delta){
  const i=state.items.findIndex(r=>r.id===id); if(i<0) return;
  const isOwner=byEmail(state.items[i].owner)===byEmail(state.user.email);
  if(state.user.role!=='admin' && !isOwner){alert('Puoi modificare solo i tuoi record.');return;}
  state.items[i].qty=Math.max(0, Number(state.items[i].qty||0)+Number(delta||0));
  saveItems();
  renderStock(); renderStats();
}

/* ===== WIREUP ===== */
ensureSeedUsers(); renderNav();
document.getElementById('btnLogin').addEventListener('click',()=>login(document.getElementById('email').value,document.getElementById('password').value));
document.getElementById('btnLogout').addEventListener('click',logout);

// stock events
document.getElementById('search').addEventListener('input',()=>renderStock());
document.getElementById('filterOwner').addEventListener('change',()=>renderStock());
document.getElementById('btnAdd').addEventListener('click',addItem);
document.getElementById('tbody').addEventListener('click',e=>{
  const b=e.target.closest('button[data-action]'); if(!b) return;
  const tr=b.closest('tr'); const id=b.dataset.id||tr?.dataset?.id;
  const qtyInput=tr.querySelector('[data-qty]'); let v=Number(qtyInput?.value||1); if(!Number.isFinite(v)||v<1) v=1;
  if(b.dataset.action==='in') moveItem(id,+v);
  if(b.dataset.action==='out') moveItem(id,-v);
});
document.getElementById('btnExport').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='stockapp_export.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('fileImport').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader();
  rd.onload=ev=>{try{const arr=JSON.parse(ev.target.result); if(!Array.isArray(arr)) throw 0;
    state.items=arr.map(x=>({id:x.id||uid(),owner:byEmail(x.owner||''),finis:x.finis||'',complete:x.complete||'',desc:x.desc||x.description||'',note:x.note||'',qty:Math.max(0,Number(x.qty||0)),createdAt:x.createdAt||Date.now()}));
    saveItems(); renderStock(); renderStats();
  }catch{alert('JSON non valido');}};
  rd.readAsText(f); e.target.value='';
});

// users events (admin)
document.getElementById('btnAddUser').addEventListener('click',()=>{
  loadUsers();
  const email=byEmail(document.getElementById('uEmail').value);
  const pass=document.getElementById('uPassword').value.trim();
  const role=document.getElementById('uRole').value;
  if(!email||!pass) return alert('Email e password richieste');
  if(state.users.some(u=>byEmail(u.email)===email)) return alert('Utente già presente');
  state.users.push({email,pass,role}); saveUsers();
  document.getElementById('uEmail').value=''; document.getElementById('uPassword').value=''; document.getElementById('uRole').value='user';
  renderUsers();
});
document.getElementById('uSearch').addEventListener('input',renderUsers);
document.getElementById('uBody').addEventListener('change',e=>{
  const sel=e.target.closest('select[data-urole]'); if(!sel) return;
  loadUsers(); const em=byEmail(sel.getAttribute('data-urole')); const u=state.users.find(x=>byEmail(x.email)===em);
  if(!u) return; u.role=sel.value; saveUsers(); if(state.user && byEmail(state.user.email)===em){state.user.role=u.role; renderNav();}
});
document.getElementById('uBody').addEventListener('click',e=>{
  const b=e.target.closest('button[data-action]'); if(!b) return;
  const email=b.getAttribute('data-email'); loadUsers();
  if(b.dataset.action==='reset'){ const pw=prompt(`Nuova password per ${email}:`,''); if(pw && pw.trim()){const u=state.users.find(x=>byEmail(x.email)===byEmail(email)); if(u){u.pass=pw.trim(); saveUsers(); alert('Password aggiornata.');}}}
  if(b.dataset.action==='del'){ if(!confirm(`Eliminare ${email}?`)) return; state.users=state.users.filter(x=>byEmail(x.email)!==byEmail(email)); saveUsers(); if(state.user && byEmail(state.user.email)===byEmail(email)){state.user=null; renderNav(); routeTo('#/stock');} renderUsers();}
});

// stats events
document.getElementById('sApply').addEventListener('click',renderStats);

// initial route
if(!state.user){document.getElementById('page-auth').classList.remove('d-none');}
routeTo(location.hash||'#/stock');
renderNav();
renderStock(); renderUsers(); renderStats();
</script>
</body>
</html>
