<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockApp (Static)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0a0c10; --panel:#131622; --muted:#9aa3af;
      --border:#1f2330; --primary:#3b82f6; --accent:#10b981; --danger:#ef4444;
    }
    body{background:var(--bg); color:#e8eaee}
    .navbar{background:#0f121b}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px}
    .metric{font-size:2.6rem; font-weight:700; letter-spacing:.5px}
    .form-control, .form-select{background:#0e1220; color:#e8eaee; border-color:#1e2432}
    .form-control:focus{box-shadow:none; border-color:var(--primary)}
    .btn-primary{background:var(--primary); border-color:var(--primary)}
    .btn-success{background:var(--accent); border-color:var(--accent)}
    .btn-outline-light{border-color:#2a3142}
    .badge-role{background:#1c2231}
    .table-dark{--bs-table-bg:#111425; --bs-table-striped-bg:#0e1120}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-box-seam me-2"></i>StockApp</a>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light d-none" type="button">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-4">

  <!-- AUTH -->
  <div id="cardAuth" class="card mb-4">
    <div class="card-body">
      <h3 class="h5 mb-3">Accesso</h3>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" autocomplete="username" placeholder="admin@example.com" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" autocomplete="current-password" placeholder="••••••" />
        </div>
        <div class="col-md-4">
          <button id="btnLogin" class="btn btn-primary w-100" type="button">
            <i class="bi bi-box-arrow-in-right me-1"></i>Entra
          </button>
          <small class="muted d-block mt-2">
            Utenti creati automaticamente al primo avvio:<br>
            Admin → <code>admin@example.com / admin</code><br>
            User  → <code>user1@example.com / user</code>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="rowDash" class="row g-3 d-none">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto">
            <h5 class="card-title mb-1">Articoli</h5>
            <div class="muted small">Conteggio record visibili</div>
          </div>
          <div id="metricItems" class="metric">0</div>
        </div>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto">
            <h5 class="card-title mb-1">Giacenza totale</h5>
            <div class="muted small">Somma Qty visibili</div>
          </div>
          <div id="metricQty" class="metric">0</div>
        </div>
      </div></div>
    </div>
  </div>

  <!-- STOCK -->
  <div id="cardStock" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Magazzino</h3>
        <input id="search" class="form-control" placeholder="Cerca Finis / Complete / Descrizione / Note" style="max-width:380px" />
      </div>

      <!-- Add form (per tutti: Admin e User) -->
      <div id="addBar" class="mb-3">
        <div class="row g-2">
          <div class="col-lg-2"><input id="newFinis" class="form-control" placeholder="Finis Code" /></div>
          <div class="col-lg-2"><input id="newComplete" class="form-control" placeholder="Complete Code" /></div>
          <div class="col-lg-3"><input id="newDesc" class="form-control" placeholder="Descrizione" /></div>
          <div class="col-lg-3"><input id="newNote" class="form-control" placeholder="Note" /></div>
          <div class="col-lg-2 d-grid"><button id="btnAdd" class="btn btn-success" type="button"><i class="bi bi-plus-lg me-1"></i>Aggiungi</button></div>
        </div>
        <div class="muted small mt-1">I nuovi record saranno di proprietà: <span id="ownerHint"></span></div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle mb-2">
          <thead>
            <tr>
              <th>Finis Code</th>
              <th>Complete Code</th>
              <th>Descrizione</th>
              <th>Note</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Azioni</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-light" type="button"><i class="bi bi-download me-1"></i>Esporta JSON</button>
        <label class="btn btn-outline-light mb-0">
          <i class="bi bi-upload me-1"></i>Importa JSON <input id="fileImport" type="file" accept="application/json" hidden>
        </label>
      </div>
      <div class="muted small mt-2">Dati salvati nel browser (localStorage). Visibilità in base al proprietario (owner=email).</div>
    </div>
  </div>

  <!-- USERS (ADMIN ONLY) -->
  <div id="cardUsers" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Gestione Utenti</h3>
        <input id="uSearch" class="form-control" placeholder="Cerca email" style="max-width:320px" />
      </div>

      <div class="row g-2 mb-3">
        <div class="col-lg-4"><input id="uEmail" class="form-control" placeholder="email@dominio.it" /></div>
        <div class="col-lg-3"><input id="uPassword" class="form-control" placeholder="password" /></div>
        <div class="col-lg-3">
          <select id="uRole" class="form-select">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="col-lg-2 d-grid"><button id="btnAddUser" class="btn btn-success" type="button"><i class="bi bi-person-plus me-1"></i>Aggiungi</button></div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead><tr><th>Email</th><th>Ruolo</th><th class="text-end">Azioni</th></tr></thead>
          <tbody id="uBody"></tbody>
        </table>
      </div>
      <div class="muted small">⚠️ Demo: utenti salvati in localStorage (non sicuro per produzione).</div>
    </div>
  </div>

</main>

<script type="module">
/* =========================
   KEYS & STATE
   ========================= */
const LS_ITEMS = 'stockapp.items.v3';
const LS_USERS = 'stockapp.users.v1';

let state = {
  user: null,  // {email, role}
  items: [],   // [{id, owner, finis, complete, desc, note, qty}]
  users: []    // [{email, pass, role}]
};

const uid = () => Math.random().toString(36).slice(2,10);
const byEmail = (e) => (e||'').trim().toLowerCase();

/* =========================
   STORAGE
   ========================= */
function loadItems(){ try{ state.items = JSON.parse(localStorage.getItem(LS_ITEMS)||'[]'); }catch{ state.items=[]; } }
function saveItems(){ localStorage.setItem(LS_ITEMS, JSON.stringify(state.items)); }

function loadUsers(){ try{ state.users = JSON.parse(localStorage.getItem(LS_USERS)||'[]'); }catch{ state.users=[]; } }
function saveUsers(){ localStorage.setItem(LS_USERS, JSON.stringify(state.users)); }

// seed admin + user1
function ensureSeedUsers(){
  loadUsers();
  if(state.users.length===0){
    state.users = [
      { email: 'admin@example.com', pass: 'admin', role: 'admin' },
      { email: 'user1@example.com', pass: 'user',  role: 'user'  },
    ];
    saveUsers();
  }
}

/* =========================
   AUTH
   ========================= */
function login(email, password){
  ensureSeedUsers();
  const e = byEmail(email);
  const p = (password||'').trim();
  const u = state.users.find(u => byEmail(u.email)===e);
  if(!u || u.pass!==p){ alert('Credenziali non valide'); return; }
  state.user = { email: u.email, role: u.role };
  loadItems();
  render();
}
function logout(){ state.user=null; render(); }

/* =========================
   QUERIES & METRICS
   ========================= */
function visibleItems(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  let arr = state.items;
  if(state.user.role!=='admin'){
    arr = arr.filter(r => byEmail(r.owner) === byEmail(state.user.email));
  }
  if(q){
    arr = arr.filter(r =>
      (r.finis||'').toLowerCase().includes(q) ||
      (r.complete||'').toLowerCase().includes(q) ||
      (r.desc||'').toLowerCase().includes(q) ||
      (r.note||'').toLowerCase().includes(q)
    );
  }
  return arr;
}
function metrics(arr){
  return {
    totalItems: arr.length,
    totalQty: arr.reduce((a,b)=>a + Math.max(0, Number(b.qty||0)), 0)
  };
}

/* =========================
   RENDER
   ========================= */
function render(){
  const cardAuth = document.getElementById('cardAuth');
  const rowDash  = document.getElementById('rowDash');
  const cardStock= document.getElementById('cardStock');
  const cardUsers= document.getElementById('cardUsers');
  const userInfo = document.getElementById('userInfo');
  const btnLogout= document.getElementById('btnLogout');

  if(!state.user){
    cardAuth.classList.remove('d-none');
    rowDash.classList.add('d-none');
    cardStock.classList.add('d-none');
    cardUsers.classList.add('d-none');
    userInfo.classList.add('d-none');
    btnLogout.classList.add('d-none');
    return;
  }
  cardAuth.classList.add('d-none');
  rowDash.classList.remove('d-none');
  cardStock.classList.remove('d-none');
  userInfo.classList.remove('d-none');
  btnLogout.classList.remove('d-none');

  userInfo.textContent = `${state.user.email} • ${state.user.role}`;
  document.getElementById('ownerHint').textContent = state.user.email;

  // items
  const list = visibleItems();
  const { totalItems, totalQty } = metrics(list);
  document.getElementById('metricItems').textContent = totalItems;
  document.getElementById('metricQty').textContent   = totalQty;

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  for(const it of list){
    const tr = document.createElement('tr');
    tr.dataset.id = it.id;
    tr.innerHTML = `
      <td>${esc(it.finis)}</td>
      <td>${esc(it.complete)}</td>
      <td>${esc(it.desc)}</td>
      <td>${esc(it.note)}</td>
      <td class="text-end">${Number(it.qty||0)}</td>
      <td class="text-end">
        <div class="d-inline-flex align-items-center gap-1">
          <input type="number" min="1" step="1" value="1"
                 class="form-control form-control-sm w-auto" data-qty>
          <button type="button" class="btn btn-sm btn-primary" data-action="in"  data-id="${it.id}">
            <i class="bi bi-plus-lg me-1"></i>Carico
          </button>
          <button type="button" class="btn btn-sm btn-outline-light" data-action="out" data-id="${it.id}">
            <i class="bi bi-dash-lg me-1"></i>Scarico
          </button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }

  // users (admin only)
  if(state.user.role==='admin'){
    cardUsers.classList.remove('d-none');
    renderUsers();
  } else {
    cardUsers.classList.add('d-none');
  }
}

function renderUsers(){
  loadUsers();
  const q = document.getElementById('uSearch').value.trim().toLowerCase();
  const rows = state.users
    .filter(u => !q || u.email.toLowerCase().includes(q))
    .sort((a,b)=>a.email.localeCompare(b.email));

  const uBody = document.getElementById('uBody');
  uBody.innerHTML = '';
  for(const u of rows){
    const tr = document.createElement('tr');
    tr.dataset.email = u.email;
    tr.innerHTML = `
      <td>${esc(u.email)}</td>
      <td>
        <select class="form-select form-select-sm w-auto d-inline" data-urole="${esc(u.email)}">
          <option value="user"  ${u.role==='user'?'selected':''}>User</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
        </select>
      </td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-light me-1" data-action="reset" data-email="${esc(u.email)}">
          <i class="bi bi-key"></i> Reset PW
        </button>
        <button class="btn btn-sm btn-outline-danger" data-action="del" data-email="${esc(u.email)}">
          <i class="bi bi-trash"></i> Elimina
        </button>
      </td>`;
    uBody.appendChild(tr);
  }
}

/* =========================
   HELPERS & ACTIONS
   ========================= */
function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function addItem(){
  const finis    = document.getElementById('newFinis').value.trim();
  const complete = document.getElementById('newComplete').value.trim();
  const desc     = document.getElementById('newDesc').value.trim();
  const note     = document.getElementById('newNote').value.trim();
  if(!finis && !complete){ alert('Inserisci almeno Finis o Complete Code'); return; }
  const rec = { id: uid(), owner: state.user.email, finis, complete, desc, note, qty: 0 };
  state.items.push(rec); saveItems();
  ['newFinis','newComplete','newDesc','newNote'].forEach(id=>document.getElementById(id).value='');
  render();
}

function moveItem(id, delta){
  const i = state.items.findIndex(r=>r.id===id);
  if(i<0) return;
  const isOwner = byEmail(state.items[i].owner)===byEmail(state.user.email);
  if(state.user.role!=='admin' && !isOwner){ alert('Puoi modificare solo i tuoi record.'); return; }
  const newQty = Math.max(0, Number(state.items[i].qty||0) + Number(delta||0));
  state.items[i].qty = newQty; saveItems(); render();
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(state.items, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'stockapp_export.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const rd = new FileReader();
  rd.onload = e=>{
    try{
      const arr = JSON.parse(e.target.result);
      if(!Array.isArray(arr)) throw new Error('Formato non valido');
      state.items = arr.map(x=>({
        id: x.id || uid(),
        owner: byEmail(x.owner||''),
        finis: x.finis||'',
        complete: x.complete||'',
        desc: x.desc||x.description||'',
        note: x.note||'',
        qty: Math.max(0, Number(x.qty||0))
      }));
      saveItems(); render();
    }catch{ alert('JSON non valido'); }
  };
  rd.readAsText(file);
}

/* === Users (admin) === */
function addUser(){
  ensureSeedUsers(); loadUsers();
  const email = byEmail(document.getElementById('uEmail').value);
  const pass  = document.getElementById('uPassword').value.trim();
  const role  = document.getElementById('uRole').value;
  if(!email || !pass) return alert('Email e password richieste');
  if(state.users.some(u=>byEmail(u.email)===email)){ alert('Utente già presente'); return; }
  state.users.push({ email, pass, role }); saveUsers();
  document.getElementById('uEmail').value=''; document.getElementById('uPassword').value=''; document.getElementById('uRole').value='user';
  renderUsers();
}
function setUserRole(email, role){
  loadUsers();
  const u = state.users.find(u=>byEmail(u.email)===byEmail(email));
  if(!u) return; u.role = role; saveUsers(); if(byEmail(state.user.email)===byEmail(email)) state.user.role=role; renderUsers(); render();
}
function resetPassword(email){
  loadUsers();
  const u = state.users.find(u=>byEmail(u.email)===byEmail(email));
  if(!u) return;
  const pw = prompt(`Nuova password per ${u.email}:`, '');
  if(pw===null) return;
  const p = pw.trim(); if(!p) return alert('Password vuota');
  u.pass = p; saveUsers(); alert('Password aggiornata.');
}
function deleteUser(email){
  if(!confirm(`Eliminare l'utente ${email}?`)) return;
  loadUsers();
  state.users = state.users.filter(u=>byEmail(u.email)!==byEmail(email));
  saveUsers();
  if(byEmail(state.user.email)===byEmail(email)){ state.user=null; }
  renderUsers(); render();
}

/* =========================
   BOOT & EVENTS
   ========================= */
ensureSeedUsers(); loadItems(); render();

document.getElementById('btnLogin').addEventListener('click', ()=>login(
  document.getElementById('email').value, document.getElementById('password').value
));
document.getElementById('btnLogout').addEventListener('click', logout);

document.getElementById('search').addEventListener('input', render);

document.getElementById('btnAdd').addEventListener('click', addItem);
document.getElementById('btnExport').addEventListener('click', exportJSON);
document.getElementById('fileImport').addEventListener('change', e=>{
  if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value='';
});

// Movimento qty: event delegation robusto
document.getElementById('tbody').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button[data-action]');
  if(!btn) return;
  const tr = btn.closest('tr');
  const id = btn.dataset.id || tr?.dataset?.id;
  const qtyInput = tr.querySelector('[data-qty]');
  let val = Number(qtyInput?.value || 1);
  if(!Number.isFinite(val) || val < 1) val = 1; // sempre positivo
  if(btn.dataset.action==='in')  moveItem(id, +val);
  if(btn.dataset.action==='out') moveItem(id, -val); // clamp a 0 dentro moveItem
});

// Users (admin)
document.getElementById('btnAddUser').addEventListener('click', addUser);
document.getElementById('uSearch').addEventListener('input', renderUsers);
document.getElementById('uBody').addEventListener('change', (e)=>{
  const sel = e.target.closest('select[data-urole]');
  if(!sel) return;
  setUserRole(sel.getAttribute('data-urole'), sel.value);
});
document.getElementById('uBody').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-action]');
  if(!b) return;
  const email = b.getAttribute('data-email');
  if(b.dataset.action==='del')  deleteUser(email);
  if(b.dataset.action==='reset') resetPassword(email);
});
</script>
</body>
</html>
