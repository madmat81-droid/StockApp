<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockApp (Static)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0a0c10; --panel:#131622; --muted:#9aa3af;
      --border:#1f2330; --primary:#3b82f6; --accent:#10b981; --danger:#ef4444;
    }
    body{background:var(--bg); color:#e8eaee}
    .navbar{background:#0f121b}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px}
    .metric{font-size:2.6rem; font-weight:700; letter-spacing:.5px}
    .form-control, .form-select{
      background:#0e1220; color:#e8eaee; border-color:#1e2432
    }
    .form-control:focus{box-shadow:none; border-color:var(--primary)}
    .btn-primary{background:var(--primary); border-color:var(--primary)}
    .btn-success{background:var(--accent); border-color:var(--accent)}
    .btn-outline-light{border-color:#2a3142}
    .badge-role{background:#1c2231}
    .table-dark{--bs-table-bg:#111425; --bs-table-striped-bg:#0e1120}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-box-seam me-2"></i>StockApp</a>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <span id="userInfo" class="badge rounded-pill badge-role d-none"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light d-none">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-4">

  <!-- AUTH -->
  <div id="cardAuth" class="card mb-4">
    <div class="card-body">
      <h3 class="h5 mb-3">Accesso</h3>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" autocomplete="username" placeholder="admin@example.com" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" autocomplete="current-password" placeholder="••••••" />
        </div>
        <div class="col-md-4">
          <button id="btnLogin" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-right me-1"></i>Entra</button>
          <small class="muted d-block mt-2">
            Demo:<br>
            Admin → <code>admin@example.com / admin</code><br>
            User  → <code>user1@example.com / user</code>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="rowDash" class="row g-3 d-none">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto">
            <h5 class="card-title mb-1">Articoli</h5>
            <div class="muted small">Conteggio record visibili</div>
          </div>
          <div id="metricItems" class="metric">0</div>
        </div>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-auto">
            <h5 class="card-title mb-1">Giacenza totale</h5>
            <div class="muted small">Somma Qty visibili</div>
          </div>
          <div id="metricQty" class="metric">0</div>
        </div>
      </div></div>
    </div>
  </div>

  <!-- STOCK -->
  <div id="cardStock" class="card mt-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center mb-3 gap-2">
        <h3 class="h5 me-auto mb-0">Magazzino</h3>
        <input id="search" class="form-control" placeholder="Cerca Finis / Complete / Descrizione / Note" style="max-width:380px" />
      </div>

      <!-- Admin: create -->
      <div id="adminBar" class="mb-3 d-none">
        <div class="row g-2">
          <div class="col-lg-2"><input id="newFinis" class="form-control" placeholder="Finis Code" /></div>
          <div class="col-lg-2"><input id="newComplete" class="form-control" placeholder="Complete Code" /></div>
          <div class="col-lg-3"><input id="newDesc" class="form-control" placeholder="Descrizione" /></div>
          <div class="col-lg-3"><input id="newNote" class="form-control" placeholder="Note" /></div>
          <div class="col-lg-2 d-grid"><button id="btnAdd" class="btn btn-success"><i class="bi bi-plus-lg me-1"></i>Aggiungi</button></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Finis Code</th>
              <th>Complete Code</th>
              <th>Descrizione</th>
              <th>Note</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Azioni</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-light"><i class="bi bi-download me-1"></i>Esporta JSON</button>
        <label class="btn btn-outline-light mb-0">
          <i class="bi bi-upload me-1"></i>Importa JSON <input id="fileImport" type="file" accept="application/json" hidden>
        </label>
      </div>
      <div class="muted small mt-2">I dati sono salvati nel tuo browser (localStorage). Ruoli/visibilità si basano sull’indirizzo email.</div>
    </div>
  </div>
</main>

<script type="module">
/* =========================
   STATE & STORAGE (scoped)
   ========================= */
const LS_KEY = 'stockapp.items.v2';
let state = {
  user: null,    // {email, role}
  items: []      // [{id, owner, finis, complete, desc, note, qty}]
};
const uid = () => Math.random().toString(36).slice(2,10);

function loadLocal(){ try{ state.items = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.items=[]; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.items)); }

/* =========================
   AUTH (demo)
   ========================= */
function login(email, password){
  email = (email||'').trim().toLowerCase();
  const pass = (password||'').trim();

  // DEMO users
  const users = {
    'admin@example.com': { role:'admin', pass:'admin' },
    'user1@example.com': { role:'user',  pass:'user'  },
  };
  const u = users[email];
  if(!u || u.pass !== pass){ alert('Credenziali non valide'); return; }

  state.user = { email, role:u.role };
  loadLocal();
  render();
}
function logout(){ state.user=null; render(); }

/* =========================
   FILTER & METRICS
   ========================= */
function visibleItems(){
  if(!state.user) return [];
  const q = document.getElementById('search').value.trim().toLowerCase();
  let arr = state.items;
  if(state.user.role !== 'admin'){
    arr = arr.filter(r => (r.owner||'').toLowerCase() === state.user.email);
  }
  if(q){
    arr = arr.filter(r =>
      (r.finis||'').toLowerCase().includes(q) ||
      (r.complete||'').toLowerCase().includes(q) ||
      (r.desc||'').toLowerCase().includes(q) ||
      (r.note||'').toLowerCase().includes(q)
    );
  }
  return arr;
}
function metrics(arr){
  const totalItems = arr.length;
  const totalQty = arr.reduce((a,b)=>a + Number(b.qty||0), 0);
  return { totalItems, totalQty };
}

/* =========================
   RENDER
   ========================= */
function render(){
  const cardAuth = document.getElementById('cardAuth');
  const rowDash  = document.getElementById('rowDash');
  const cardStock= document.getElementById('cardStock');
  const userInfo = document.getElementById('userInfo');
  const btnLogout= document.getElementById('btnLogout');
  const adminBar = document.getElementById('adminBar');
  const tbody    = document.getElementById('tbody');

  if(!state.user){
    cardAuth.classList.remove('d-none');
    rowDash.classList.add('d-none');
    cardStock.classList.add('d-none');
    userInfo.classList.add('d-none');
    btnLogout.classList.add('d-none');
    return;
  }
  cardAuth.classList.add('d-none');
  rowDash.classList.remove('d-none');
  cardStock.classList.remove('d-none');
  userInfo.classList.remove('d-none');
  btnLogout.classList.remove('d-none');

  userInfo.textContent = `${state.user.email} • ${state.user.role}`;

  const list = visibleItems();
  const { totalItems, totalQty } = metrics(list);
  document.getElementById('metricItems').textContent = totalItems;
  document.getElementById('metricQty').textContent   = totalQty;

  tbody.innerHTML = '';
  for(const it of list){
    const tr = document.createElement('tr');
    tr.dataset.id = it.id;
    tr.innerHTML = `
      <td>${escapeHTML(it.finis||'')}</td>
      <td>${escapeHTML(it.complete||'')}</td>
      <td>${escapeHTML(it.desc||'')}</td>
      <td>${escapeHTML(it.note||'')}</td>
      <td class="text-end">${Number(it.qty||0)}</td>
      <td class="text-end">
        <div class="d-inline-flex align-items-center gap-1">
          <input type="number" min="1" step="1" value="1"
                 class="form-control form-control-sm w-auto" data-qty>
          <button class="btn btn-sm btn-primary" data-action="in"><i class="bi bi-plus-lg me-1"></i>Carico</button>
          <button class="btn btn-sm btn-outline-light" data-action="out"><i class="bi bi-dash-lg me-1"></i>Scarico</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }
  adminBar.classList.toggle('d-none', state.user.role!=='admin');
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* =========================
   ACTIONS
   ========================= */
function addItem(){
  const finis    = document.getElementById('newFinis').value.trim();
  const complete = document.getElementById('newComplete').value.trim();
  const desc     = document.getElementById('newDesc').value.trim();
  const note     = document.getElementById('newNote').value.trim();
  if(!finis && !complete){ return alert('Inserisci almeno Finis o Complete Code'); }
  const rec = {
    id: uid(),
    owner: state.user.email,     // chi crea il record
    finis, complete, desc, note,
    qty: 0
  };
  state.items.push(rec);
  saveLocal();
  // pulizia form
  ['newFinis','newComplete','newDesc','newNote'].forEach(id => document.getElementById(id).value='');
  render();
}

function moveItem(id, delta){
  const idx = state.items.findIndex(r => r.id===id);
  if(idx<0) return;
  // autorizzazione: user può modificare solo i propri record
  const isOwner = (state.items[idx].owner||'').toLowerCase() === state.user.email;
  if(state.user.role!=='admin' && !isOwner){
    alert('Non puoi modificare un record non tuo.'); return;
  }
  const q = Number(state.items[idx].qty||0) + Number(delta);
  state.items[idx].qty = Math.max(0, q); // MAI negativo
  saveLocal();
  render();
}

/* =========================
   EXPORT / IMPORT
   ========================= */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state.items, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'stockapp_export.json';
  a.click(); URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const arr = JSON.parse(e.target.result);
      if(!Array.isArray(arr)) throw new Error('Formato non valido');
      // opzionale: normalizza campi
      state.items = arr.map(x => ({
        id: x.id || uid(),
        owner: (x.owner||'').toLowerCase(),
        finis: x.finis||'',
        complete: x.complete||'',
        desc: x.desc||x.description||'',
        note: x.note||'',
        qty: Math.max(0, Number(x.qty||0))
      }));
      saveLocal(); render();
    }catch{ alert('JSON non valido'); }
  };
  reader.readAsText(file);
}

/* =========================
   WIREUP (no inline onclick)
   ========================= */
loadLocal(); render();

document.getElementById('btnLogin').addEventListener('click', ()=>login(
  document.getElementById('email').value,
  document.getElementById('password').value
));
document.getElementById('btnLogout').addEventListener('click', logout);

document.getElementById('search').addEventListener('input', render);
document.getElementById('btnAdd').addEventListener('click', addItem);
document.getElementById('btnExport').addEventListener('click', exportJSON);
document.getElementById('fileImport').addEventListener('change', e=>{
  if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value='';
});

// Event delegation per i pulsanti della tabella
document.getElementById('tbody').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button[data-action]');
  if(!btn) return;
  const tr = ev.target.closest('tr');
  const id = tr?.dataset?.id;
  const qtyInput = tr.querySelector('[data-qty]');
  const val = Math.max(1, Number(qtyInput?.value||1)); // sempre >=1
  if(btn.dataset.action==='in')  moveItem(id, +val);
  if(btn.dataset.action==='out') moveItem(id, -val);   // clamp a 0 nella funzione
});
</script>
</body>
</html>
